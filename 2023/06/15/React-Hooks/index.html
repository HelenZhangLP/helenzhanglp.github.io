<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="函数组件实现动态组件类组件的功能React 最新版本 v18.2，Hook 是 React 16.8 新增特性。可以在不编写 class 的情况下使用 state 以及其他 React 特性。引入 Hook 的动机——解决看起来不相关的问题Hoos 是执行函数，产生函数上下文 useState在函数组件中使用状态，并且后期基于状态修改，进而更新组件 12345678910&#x2F;** * initail">
<meta property="og:type" content="article">
<meta property="og:title" content="React Hooks">
<meta property="og:url" content="https://helenzhanglp.github.io/2023/06/15/React-Hooks/index.html">
<meta property="og:site_name" content="魔女">
<meta property="og:description" content="函数组件实现动态组件类组件的功能React 最新版本 v18.2，Hook 是 React 16.8 新增特性。可以在不编写 class 的情况下使用 state 以及其他 React 特性。引入 Hook 的动机——解决看起来不相关的问题Hoos 是执行函数，产生函数上下文 useState在函数组件中使用状态，并且后期基于状态修改，进而更新组件 12345678910&#x2F;** * initail">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-06-15T05:12:13.000Z">
<meta property="article:modified_time" content="2024-01-25T07:31:03.772Z">
<meta property="article:author" content="Helen Zhang">
<meta property="article:tag" content="React">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/logo.jpeg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/logo.jpeg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>React Hooks</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">

    
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

    
<link rel="stylesheet" href="/css/style.css">

    <!-- rss -->
    
    
    <!-- jquery -->
    
<script src="/lib/jquery/jquery.min.js"></script>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>

<body>
    <div class="banner">
<div id="blogtitel" class="blogtitel">魔女</div>
<ul id="wrapper" class="wrapper">
  <div class="sun">
    <div class="star"></div>
  </div>
  <div class="mercury">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="venus">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="earth">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="mars">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="jupiter">
    <div class="planet"><div class="shadow"></div></div>
  </div>
</ul>
</div>

    <div class="background">
      
        <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i
      class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        
          <li><a href="/">
              Home
            </a></li>
          
          <li><a href="/about/">
              About
            </a></li>
          
          <li><a href="/archives/">
              Writing
            </a></li>
          
          <li><a href="/tags/">
              Tags
            </a></li>
          
          <li><a target="_blank" rel="noopener" href="https://github.com/HelenZhangLP">
              Projects
            </a></li>
          
      </ul>
    </span>
    <br />
    <span id="actions">
      <ul>
        
          <li><a class="icon" href="/2023/08/07/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AF/"><i class="fa fa-chevron-left" aria-hidden="true"
                onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
          
            
              <li><a class="icon" href="/2023/06/15/React-Class-Component/"><i class="fa fa-chevron-right"
                    aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a>
              </li>
              
                <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i
                      class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();'
                      onmouseout='$("#i-top").toggle();'></i></a></li>
                <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true"
                      onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();'
                      onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br />
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://helenzhanglp.github.io/2023/06/15/React-Hooks/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&text=React Hooks"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&title=React Hooks"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&is_video=false&description=React Hooks"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=React Hooks&body=Check out this article: https://helenzhanglp.github.io/2023/06/15/React-Hooks/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&title=React Hooks"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&title=React Hooks"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&title=React Hooks"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&title=React Hooks"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&name=React Hooks&description=&lt;p&gt;函数组件实现动态组件类组件的功能&lt;br&gt;React 最新版本 v18.2，Hook 是 React 16.8 新增特性。可以在不编写 class 的情况下使用 state 以及其他 React 特性。&lt;br&gt;引入 Hook 的动机——解决看起来不相关的问题&lt;br&gt;Hoos 是执行函数，产生函数上下文&lt;/p&gt;
&lt;h2 id=&#34;useState&#34;&gt;&lt;a href=&#34;#useState&#34; class=&#34;headerlink&#34; title=&#34;useState&#34;&gt;&lt;/a&gt;useState&lt;/h2&gt;&lt;p&gt;在函数组件中使用状态，并且后期基于状态修改，进而更新组件&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;/**&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; * initailValue 执行 useState 传递初始状态值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; * useState 返回一个数组，包括两个元素 [状态值，修改状态值的方法]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; *  attribute 获取的状态值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; *  setAttribute 修改状态值的方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; *      setAttribute(value)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; *          修改状态值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; *          更新视图&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; */&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;let&lt;/span&gt; [attribute, setAttribute] = &lt;span class=&#34;title function_&#34;&gt;useState&lt;/span&gt;(initailValue)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;Demo&#34;&gt;&lt;a href=&#34;#Demo&#34; class=&#34;headerlink&#34; title=&#34;Demo&#34;&gt;&lt;/a&gt;Demo&lt;/h3&gt;&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 函数组件中使用状态，更新视图&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;default&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;Demo&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;let&lt;/span&gt; [num, setNum] = &lt;span class=&#34;title function_&#34;&gt;useState&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;handleBtn&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;title function_&#34;&gt;setNum&lt;/span&gt;(++num)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 函数组件不需要创建实例，没有 this&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;Button&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;type&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;primary&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;onClick&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;#123;handleBtn&amp;#125;&lt;/span&gt;&amp;gt;&lt;/span&gt;按钮&amp;#123;num&amp;#125;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;Button&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;关于函数组件渲染更新&#34;&gt;&lt;a href=&#34;#关于函数组件渲染更新&#34; class=&#34;headerlink&#34; title=&#34;关于函数组件渲染更新&#34;&gt;&lt;/a&gt;关于函数组件渲染更新&lt;/h3&gt;&lt;pre class=&#34;mermaid&#34;&gt; flowchart TB
 subgraph ExcuteContext1
    subgraph 渲染EC1
        EC1[&#34;
            &lt;b style=&#34;color: #a33&#34;&gt;// 私有变量&lt;/b&gt;
            num = 0;
            setNum = function(){/* 修改状态函数 */};
            handle = function(){/* 事件处理函数 */}
        &#34;] --&gt; parse[编译JSX视图]
        parse --&gt; virtualDOM[创建VirtualDOM]
        virtualDOM --&gt; realDOM[&#34;创建真实DOM，页面渲染&#34;]
    end
    subgraph handle
         CLICK[&#34;
            &lt;b style=&#34;color: #a33&#34;&gt;// 私有变量&lt;/b&gt;
            setNum(++num) &lt;b style=&#34;color: #a33&#34;&gt;// 修改状态 + 更新视图&lt;/b&gt;
        &#34;] -.-&gt; EC1
    end
 end
 subgraph ExcuteContext2
    subgraph 更新EC2
        EC2[&#34;
            &lt;b style=&#34;color: #a33&#34;&gt;// 私有变量&lt;/b&gt;
            num = 1;
            setNum = function(){/* 修改状态函数 */};
            handle = function(){/* 事件处理函数 */}
        &#34;] --&gt; parse2[编译JSX视图]
        parse2 --&gt; virtualDOM2[创建VirtualDOM]
        virtualDOM2 --&gt;|&#34;diff 算法&#34;| realDOM2[&#34;创建真实DOM，页面渲染&#34;]
    end
    subgraph handle2
         CLICK2[&#34;
            &lt;b style=&#34;color: #a33&#34;&gt;// 私有变量&lt;/b&gt;
            setNum(++num) &lt;b style=&#34;color: #a33&#34;&gt;// 修改状态 + 更新视图&lt;/b&gt;
        &#34;] -.-&gt; EC2
    end
 end

 渲染EC1 --&gt;|&#34;重新执行DOM函数，产生新的函数执行上下文&#34;| 更新EC2&lt;/pre&gt;
&lt;h4 id=&#34;疑问&#34;&gt;&lt;a href=&#34;#疑问&#34; class=&#34;headerlink&#34; title=&#34;疑问&#34;&gt;&lt;/a&gt;疑问&lt;/h4&gt;&lt;p&gt;&lt;span class=&#34;custom-box custom-box-939&#34;&gt;点击按钮 3 秒钟之后，num 输出是几？？？&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;custom-box custom-box-393&#34;&gt;答案是 0。在 ExcuteContext1 作用域下，按照作用域链，访问的到的是 num = 0；不会访问 ExcuteContext2 作用域，所以 num 也不会为1。 &lt;/span&gt;&lt;/p&gt;"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#useState"><span class="toc-number">1.</span> <span class="toc-text">useState</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Demo"><span class="toc-number">1.1.</span> <span class="toc-text">Demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E5%87%BD%E6%95%B0%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E6%9B%B4%E6%96%B0"><span class="toc-number">1.2.</span> <span class="toc-text">关于函数组件渲染更新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%96%91%E9%97%AE"><span class="toc-number">1.2.1.</span> <span class="toc-text">疑问</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#useState-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.3.</span> <span class="toc-text">useState 源码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%BB%84%E4%BB%B6%E5%A4%84%E7%90%86%E5%A4%9A%E7%8A%B6%E6%80%81"><span class="toc-number">1.4.</span> <span class="toc-text">函数组件处理多状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#useState-%E5%8F%82%E6%95%B0%E4%B8%BA%E5%87%BD%E6%95%B0"><span class="toc-number">1.5.</span> <span class="toc-text">useState 参数为函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setState-%E6%98%AF%E5%90%8C%E6%AD%A5%E8%BF%98%E6%98%AF%E5%BC%82%E6%AD%A5"><span class="toc-number">1.6.</span> <span class="toc-text">setState 是同步还是异步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setState-%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%BA%E5%88%B6"><span class="toc-number">1.7.</span> <span class="toc-text">setState 的性能优化机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-number">1.7.1.</span> <span class="toc-text">思考</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#useEffect"><span class="toc-number">2.</span> <span class="toc-text">useEffect</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E9%A1%B9%E4%B8%BA%E7%A9%BA"><span class="toc-number">2.1.</span> <span class="toc-text">依赖项为空</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="toc-number">2.2.</span> <span class="toc-text">多个依赖项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#effect-%E7%AC%AC%E4%B8%80%E6%B8%B2%E6%9F%93%E4%B8%8D%E6%89%A7%E8%A1%8C%EF%BC%8C%E6%9B%B4%E6%96%B0%E7%9A%84%E6%97%B6%E5%80%99%E8%BF%90%E8%A1%8C-callback-%E8%BF%94%E5%9B%9E%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">2.3.</span> <span class="toc-text">effect 第一渲染不执行，更新的时候运行 callback 返回的函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#useEffect-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">2.4.</span> <span class="toc-text">useEffect 原理分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Error-1"><span class="toc-number">2.5.</span> <span class="toc-text">Error - 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Error-2"><span class="toc-number">2.6.</span> <span class="toc-text">Error - 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Error-3-%E5%BF%AB%E9%80%9F%E7%82%B9%E5%87%BB-btn-%E5%90%8E%EF%BC%8C%E6%A0%B7%E5%BC%8F%E6%88%96%E5%86%85%E5%AE%B9%E4%BC%9A%E6%9C%89%E7%9F%AD%E6%9A%82%E7%9A%84%E9%97%AA%E7%83%81"><span class="toc-number">2.7.</span> <span class="toc-text">Error-3 快速点击 btn 后，样式或内容会有短暂的闪烁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#useEffect-%E4%B8%8E-useLayoutEffect-%E5%8C%BA%E5%88%AB"><span class="toc-number">2.8.</span> <span class="toc-text">useEffect 与 useLayoutEffect 区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#useRef"><span class="toc-number">3.</span> <span class="toc-text">useRef</span></a></li></ol>
    </div>
  </span>
</div>
      
      <div class="content index width mx-auto px2 my4">
          
          <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="header">
    
    <h1 class="posttitle" itemprop="name headline">
        React Hooks
    </h1>



      <div class="meta">
        <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <span itemprop="name">
            魔女
                    
          </span>
        </span>
        
    <div class="postdate">
        <time datetime="2023-06-15T05:12:13.000Z" itemprop="datePublished">2023-06-15</time>
    </div>


          
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li></ul>

      </div>
  </header>
  

    <div class="content" itemprop="articleBody">
      <p>函数组件实现动态组件类组件的功能<br>React 最新版本 v18.2，Hook 是 React 16.8 新增特性。可以在不编写 class 的情况下使用 state 以及其他 React 特性。<br>引入 Hook 的动机——解决看起来不相关的问题<br>Hoos 是执行函数，产生函数上下文</p>
<h2 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h2><p>在函数组件中使用状态，并且后期基于状态修改，进而更新组件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * initailValue 执行 useState 传递初始状态值</span></span><br><span class="line"><span class="comment"> * useState 返回一个数组，包括两个元素 [状态值，修改状态值的方法]</span></span><br><span class="line"><span class="comment"> *  attribute 获取的状态值</span></span><br><span class="line"><span class="comment"> *  setAttribute 修改状态值的方法</span></span><br><span class="line"><span class="comment"> *      setAttribute(value)</span></span><br><span class="line"><span class="comment"> *          修改状态值</span></span><br><span class="line"><span class="comment"> *          更新视图</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">let</span> [attribute, setAttribute] = <span class="title function_">useState</span>(initailValue)</span><br></pre></td></tr></table></figure>
<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数组件中使用状态，更新视图</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Demo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> [num, setNum] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">handleBtn</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">setNum</span>(++num)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 函数组件不需要创建实例，没有 this</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;handleBtn&#125;</span>&gt;</span>按钮&#123;num&#125;<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="关于函数组件渲染更新"><a href="#关于函数组件渲染更新" class="headerlink" title="关于函数组件渲染更新"></a>关于函数组件渲染更新</h3><pre class="mermaid"> flowchart TB
 subgraph ExcuteContext1
    subgraph 渲染EC1
        EC1["
            <b style="color: #a33">// 私有变量</b>
            num = 0;
            setNum = function(){/* 修改状态函数 */};
            handle = function(){/* 事件处理函数 */}
        "] --> parse[编译JSX视图]
        parse --> virtualDOM[创建VirtualDOM]
        virtualDOM --> realDOM["创建真实DOM，页面渲染"]
    end
    subgraph handle
         CLICK["
            <b style="color: #a33">// 私有变量</b>
            setNum(++num) <b style="color: #a33">// 修改状态 + 更新视图</b>
        "] -.-> EC1
    end
 end
 subgraph ExcuteContext2
    subgraph 更新EC2
        EC2["
            <b style="color: #a33">// 私有变量</b>
            num = 1;
            setNum = function(){/* 修改状态函数 */};
            handle = function(){/* 事件处理函数 */}
        "] --> parse2[编译JSX视图]
        parse2 --> virtualDOM2[创建VirtualDOM]
        virtualDOM2 -->|"diff 算法"| realDOM2["创建真实DOM，页面渲染"]
    end
    subgraph handle2
         CLICK2["
            <b style="color: #a33">// 私有变量</b>
            setNum(++num) <b style="color: #a33">// 修改状态 + 更新视图</b>
        "] -.-> EC2
    end
 end

 渲染EC1 -->|"重新执行DOM函数，产生新的函数执行上下文"| 更新EC2</pre>
<h4 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h4><p><span class='custom-box custom-box-939'>点击按钮 3 秒钟之后，num 输出是几？？？</span><br><span class='custom-box custom-box-393'>答案是 0。在 ExcuteContext1 作用域下，按照作用域链，访问的到的是 num = 0；不会访问 ExcuteContext2 作用域，所以 num 也不会为1。 </span></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Demo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> [num, setNum] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">handleBtn</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">setNum</span>(++num)</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(num) <span class="comment">// 0</span></span><br><span class="line">        &#125;, <span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 函数组件不需要创建实例，没有 this</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;handleBtn&#125;</span>&gt;</span>按钮&#123;num&#125;<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="useState-源码分析"><a href="#useState-源码分析" class="headerlink" title="useState 源码分析"></a>useState 源码分析</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@initailValue</span> 初值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> [state, setState]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> _state;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useState</span>(<span class="params">initialValue</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> _state === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">typeof</span> initailValue === <span class="string">&#x27;function&#x27;</span> ? <span class="title function_">initailValue</span>() : _state = initailValue <span class="comment">// 赋初值</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setState</span>(<span class="params">value</span>) &#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="title function_">is</span>(_state, value)) <span class="keyword">return</span> <span class="comment">// 更新值与 state 相同，返回</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> value === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">            _state = <span class="title function_">value</span>(_state) <span class="comment">// 更新队列中保存的函数</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _state = value <span class="comment">// 修改 state</span></span><br><span class="line">        &#125;</span><br><span class="line">        ... <span class="comment">// 更新视图</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [_state, setState]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="函数组件处理多状态"><a href="#函数组件处理多状态" class="headerlink" title="函数组件处理多状态"></a>函数组件处理多状态</h3><ul>
<li>方法一，useState 不能部分修改状态<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [state, setState] = <span class="title function_">useState</span>(&#123;</span><br><span class="line">    <span class="attr">deprecation</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">approve</span>: <span class="number">2</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handle</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setState</span>(&#123;</span><br><span class="line">        ...state,</span><br><span class="line">        <span class="attr">approve</span>: <span class="number">3</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>方法二，useState 分别初始化多个状态 <span class='custom-box custom-box-933'>【官方推荐】</span><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [deprecation, setDeprecation] = <span class="title function_">useState</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">let</span> [approve, setApprove] = <span class="title function_">useState</span>(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handle</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setDeprecation</span>(<span class="number">5</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="useState-参数为函数"><a href="#useState-参数为函数" class="headerlink" title="useState 参数为函数"></a>useState 参数为函数</h3><blockquote>
<p>业务处理逻辑仅在第一次组件渲染时触发，更新不使用。可以对赋初值的动作进行【惰性处理】，如下代码</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">let</span> [number, setNumber] = <span class="title function_">useState</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123;num, frequency&#125; = props, total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> (!frequency) <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> index = num; index &lt; frequency; index++) &#123;</span><br><span class="line">        total += +<span class="title class_">String</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()).<span class="title function_">substring</span>(<span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> total</span><br><span class="line">&#125;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="setState-是同步还是异步"><a href="#setState-是同步还是异步" class="headerlink" title="setState 是同步还是异步"></a>setState 是同步还是异步</h3><p><span class='custom-box custom-box-393'>React 18中，无论是使用 Hook 函数 useState 设置更新状态还是类组件 this.setState，多个状态修改是异步的；而在 React 16 中，异步操作中（如：定时器，手动事件绑定）修改状态为同步的。</span></p>
<pre class="mermaid"> flowchart TB
 start((开始)) --> setState[setState]
 setState --> isAsync{"
    是否异步代码修改状态\n(如：定时器，手动事件绑定)
    setTimeout(() => {
        setReduce(--reduce)
        setSum(plus + reduce)
    }, 1000);
"}
 isAsync -->|No| res1["state加入队列，再渲染<b style="color: #a33">【异步】</b>"]
 isAsync -->|Yes| version{"is react 16"}
 version -->|Yes| res2["修改 state，渲染<b style="color: #a33">【同步】</b>"]
 version -->|No| res1</pre>
<p><a target="_blank" rel="noopener" href="https://github.com/HelenZhangLP/react-18/blob/master/src/Hooks/Demo2/index.jsx">具体的 DEMO 案例</a></p>
<h3 id="setState-的性能优化机制"><a href="#setState-的性能优化机制" class="headerlink" title="setState 的性能优化机制"></a>setState 的性能优化机制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Demo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;render 渲染&#x27;</span>)</span><br><span class="line">    <span class="keyword">let</span> [state, setstate] = <span class="title function_">useState</span>(<span class="title class_">NaN</span>)</span><br><span class="line">    <span class="title function_">handle</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">setstate</span>(<span class="title class_">NaN</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;handle&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>不会再次渲染，因为每次修改状态值时，会拿最新修改的值与之前的状态值基于 Object.is 比较，Object.is(NaN, NaN) 返回 true; 两次修改值相同，则不会修改状态，视图也不会更新。<a href="/2021/05/11/React-Component-pureComponent/">类似于 PureComponent 中，在 shouldComponent 中作了浅比较优化</a>。</p>
</blockquote>
<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a><a target="_blank" rel="noopener" href="https://github.com/HelenZhangLP/react-18/blob/master/src/Hooks/Demo3/index.jsx">思考</a></h4><blockquote>
<p>以下代码会渲染几次，最终结果是几</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">let</span> [x, setX] = <span class="title function_">useState</span>(<span class="number">10</span>)</span><br><span class="line"><span class="title function_">handle</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">setX</span>(x + <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><span class='custom-box custom-box-393'>点击后渲染 1次，最终渲染结果是 11.</span></p>
<blockquote>
<p>以下代码会渲染几次，最终结果是几</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">let</span> [x, setX] = <span class="title function_">useState</span>(<span class="number">10</span>)</span><br><span class="line"><span class="title function_">handle</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">flushsync</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="title function_">setX</span>(x + <span class="number">1</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><span class='custom-box custom-box-393'>点击后渲染 2，最终渲染结果是 11. 原因：优化机制，消息队列中按照优化机制，不会多次渲染相同的值</span></p>
<blockquote>
<p>以下代码会渲染几次，最终结果是几</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">let</span> [x, setX] = <span class="title function_">useState</span>(<span class="number">10</span>)</span><br><span class="line"><span class="title function_">handle</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">setx</span>(<span class="function"><span class="params">prev</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> prev + <span class="number">1</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><span class='custom-box custom-box-393'>点击后渲染 1，最终渲染结果是 20. updater 队列中存储的是 10 个回调函数，每次执行回调时，拿到的是上一个计算出的 x 的值。合并处理后，渲染一次，值为 20</span></p>
<h2 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a>useEffect</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123;useEffect, useState&#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Demo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> [num, setNum] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;effect&#x27;</span>, <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;div&#x27;</span>))</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;render&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>useEffect,&#123;num&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Demo</span></span><br></pre></td></tr></table></figure>
<pre class="mermaid"> flowchart TB
 subgraph "第一次渲染【componentDidMount】"
    render --> useEffect
 end

 subgraph "更新【componentDidUpdate】"
 render1[render] --> useEffect1[useEffect]
 end</pre>
<blockquote>
<p><code>useEffect(callback)</code> 第一次渲染完后，执行 callback。更新完成后，同样再次执行 callback</p>
</blockquote>
<h3 id="依赖项为空"><a href="#依赖项为空" class="headerlink" title="依赖项为空"></a>依赖项为空</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;effect&#x27;</span>, <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;div&#x27;</span>))</span><br><span class="line">&#125;,[])</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="多个依赖项"><a href="#多个依赖项" class="headerlink" title="多个依赖项"></a>多个依赖项</h3><blockquote>
<p>任一依赖项变化，触发 callback 执行</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;effect&#x27;</span>, <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;div&#x27;</span>))</span><br><span class="line">&#125;,[ids, name])</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><span class='custom-box custom-box-933'>依赖项类似与 ComponentShouldUpdate</span></p>
<h3 id="effect-第一渲染不执行，更新的时候运行-callback-返回的函数"><a href="#effect-第一渲染不执行，更新的时候运行-callback-返回的函数" class="headerlink" title="effect 第一渲染不执行，更新的时候运行 callback 返回的函数"></a>effect 第一渲染不执行，更新的时候运行 callback 返回的函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;effect&#x27;</span>, <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;div&#x27;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="useEffect-原理分析"><a href="#useEffect-原理分析" class="headerlink" title="useEffect 原理分析"></a>useEffect 原理分析</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123;useEffect, useState&#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Demo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> [num, setNum] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;effect&#x27;</span>, <span class="string">&#x27;无依赖&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;effect&#x27;</span>, <span class="string">&#x27;依赖为空&#x27;</span>)</span><br><span class="line">    &#125;,[])</span><br><span class="line"></span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;effect&#x27;</span>, <span class="string">&#x27;依赖 num 的变化&#x27;</span>)</span><br><span class="line">    &#125;,[num])</span><br><span class="line"></span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;effect&#x27;</span>, <span class="string">&#x27;返回函数&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">handle</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">setNum</span>(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;render&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handle&#125;</span>&gt;</span>useEffect,&#123;num&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<pre class="mermaid"> flowchart TB
 subgraph 第一次渲染
    subgraph render
        s1["num=0 setNum(){}"]
        s2["useEffect(()=>{
            console.log('effect 无依赖')
        })"]
        s3["useEffect(()=>{
            console.log('effect 依赖为空')
        },[])"]
        s4["useEffect(()=>{
            console.log('effect 依赖为num')
        },[num])"]
        s5["useEffect(()=>{
            return () => {
                console.log('effect 无依赖，无输出，返回函数')
            }
        },[num])"]
    end
    subgraph effect链表
        se1["effect 无依赖"]
        se2["effect 依赖为空"]
        se3["effect 依赖为num"]
        se4["effect 无依赖，无输出，返回函数"]
    end

    render -->|"MountEffect callback 中的依赖项加入链表"| effect链表
    subgraph output
        a["effect 无依赖"]
        b["effect 依赖为空"]
        c["effect 依赖为num"]
    end
 end
 subgraph 更新
    subgraph updater
        s11["num=0 setNum(){}"]
        s21["useEffect(()=>{
            console.log('effect 无依赖')
        })"]
        s31["useEffect(()=>{
            console.log('effect 依赖为空')
        },[])"]
        s41["useEffect(()=>{
            console.log('effect 依赖为num')
        },[num])"]
        s51["useEffect(()=>{
            return () => {
                console.log('effect 无依赖，无输出，返回函数')
            }
        },[num])"]
    end
    subgraph effect链表1
        se11["effect 无依赖"]
        se21["effect 依赖为空"]
        se31["effect 依赖为num"]
        se41["effect 无依赖，无输出，返回函数"]
    end
    subgraph output1
        a1["effect 无依赖，无输出，返回函数"]
        b1["effect 无依赖"]
        c1["effect 依赖为num"]
    end
 end
 第一次渲染 -->|"点击按钮，修改 num 状态"| 更新</pre>

<h3 id="Error-1"><a href="#Error-1" class="headerlink" title="Error - 1"></a>Error - 1</h3><p><font color='red'>Line 26:9:  React Hook “useEffect” is called conditionally. React Hooks must be called in the exact same order in every component render  react-hooks/rules-of-hooks</font><br><span class='custom-box custom-box-393'>每次渲染 react hooks 都要以相同的顺序在组件中调用</span></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(num &gt; <span class="number">5</span>) &#123;</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;num&#125;</span> &gt; 5`</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>/** 正确方式 **/</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(num &gt; <span class="number">5</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;num&#125;</span> &gt; 5`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,[num])</span><br></pre></td></tr></table></figure>
<h3 id="Error-2"><a href="#Error-2" class="headerlink" title="Error - 2"></a>Error - 2</h3><p><font color='red'>react-dom.development.js:86 Warning: useEffect must not return anything besides a function, which is used for clean-up.<br>It looks like you wrote useEffect(async () =&gt; …) or returned a Promise. Instead, write the async function inside your effect and call it immediately:<br>useEffect(() =&gt; {<br>  async function fetchData() {<br>    // You can await here<br>    const response = await MyAPI.getData(someId);<br>    // …<br>  }<br>  fetchData();<br>}, [someId]); // Or [] if effect doesn’t need props or state</font></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// You can await here</span></span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title class_">MyAPI</span>.<span class="title function_">getData</span>(someId);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">fetchData</span>();</span><br><span class="line">&#125;, [someId]); </span><br></pre></td></tr></table></figure>

<h3 id="Error-3-快速点击-btn-后，样式或内容会有短暂的闪烁"><a href="#Error-3-快速点击-btn-后，样式或内容会有短暂的闪烁" class="headerlink" title="Error-3 快速点击 btn 后，样式或内容会有短暂的闪烁"></a>Error-3 <font color='red'>快速点击 btn 后，样式或内容会有短暂的闪烁</font></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Demo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> [num, setNum] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="title function_">useLayoutEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!num) <span class="title function_">setNum</span>(<span class="number">10</span>)</span><br><span class="line">    &#125;,[num])</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">handleIncremental</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">setNum</span>(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;render&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;backgroundColor:</span> <span class="attr">num</span> === <span class="string">0</span> ? &#x27;<span class="attr">red</span>&#x27; <span class="attr">:</span> &#x27;<span class="attr">lightgreen</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;num&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Button</span> <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;handleIncremental&#125;</span>&gt;</span>Incremental<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>原因分析：</p>
</blockquote>
<pre class="mermaid">%%{init: {"flowchart": {"htmlLabels": true}} }%%
 flowchart TB
 subgraph "<b style="color: green; padding:10px">组件渲染步骤</b>"
    step1["react-app 编译"]
    step2["创建 virtualDOM"]
    step3["DOM-DIFF，渲染真实 DOM"]
    step4["<b style="color: #a33">useEffect 异步执行</b>链表中方法执行"]

    step1 --> step2
    step2 --> step3
    step3 --> step4
    step4 --> step1
 end</pre>
<blockquote>
<p>那么真实 DOM 会渲染两次，所以会有内容和样式上的闪烁，使用 useLayoutEffect 解决：</p>
</blockquote>
<pre class="mermaid">%%{init: {"flowchart": {"htmlLabels": true}} }%%
 flowchart LR
 subgraph "<b style="color: green; padding:10px">组件渲染步骤</b>"
    step1["babel-preset-react-app 编译 createElement"]
    step2["createElement 创建 virtualDOM"]
    step3["root.render 把 virtualDOM 变为真实 Diff 运算"]
    step4["<b style="color: #a33">useLayoutEffect</b>阻塞渲染，<b><U>同步执行</U></b>EFFECT 链表中方法"]
    step5["渲染真实 DOM"]

    step1 --> step2
    step2 --> step3
    step3 --> step4
    step4 --> step5
 end</pre>
<p> <span class='custom-box custom-box-339'>使用 useLayoutEffect 可以解决闪烁问题，如上图真实 dom 只渲染一次，所以不会闪烁</span></p>
<h3 id="useEffect-与-useLayoutEffect-区别"><a href="#useEffect-与-useLayoutEffect-区别" class="headerlink" title="useEffect 与 useLayoutEffect 区别"></a>useEffect 与 useLayoutEffect 区别</h3><p> useLayoutEffect 会阻塞浏览器真实 DOM，优先执行 Effect 链表中的 callback；<br> useEffect 不会阻塞浏览器渲染真实 DOM，在渲染真实 DOM 的同时，去执行 Effect 链表中的 callback.<br> useLayoutEffect 优先于 useEffect 执行<br> 都可以获取 DOM 元素，原因在于真实 DOM 已经生成，区别只是 useLayoutEffect 在执行完 effect 链表后渲染 DOM 到浏览器<br> useEffect 会渲染两次，useLayoutEffect 会合并真实 DOM 渲染。</p>
<h2 id="useRef"><a href="#useRef" class="headerlink" title="useRef"></a><a href="/2021/05/11/React-Refs/#%E5%87%BD%E6%95%B0%E5%AD%90%E7%BB%84%E4%BB%B6%E4%B8%AD%E4%BD%BF%E7%94%A8-Ref-%E8%BF%9B%E8%A1%8C-DOM-%E5%A4%84%E7%90%86">useRef</a></h2>
    </div>
</article>


      </div>
      
       <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/HelenZhangLP">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#useState"><span class="toc-number">1.</span> <span class="toc-text">useState</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Demo"><span class="toc-number">1.1.</span> <span class="toc-text">Demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E5%87%BD%E6%95%B0%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E6%9B%B4%E6%96%B0"><span class="toc-number">1.2.</span> <span class="toc-text">关于函数组件渲染更新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%96%91%E9%97%AE"><span class="toc-number">1.2.1.</span> <span class="toc-text">疑问</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#useState-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.3.</span> <span class="toc-text">useState 源码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%BB%84%E4%BB%B6%E5%A4%84%E7%90%86%E5%A4%9A%E7%8A%B6%E6%80%81"><span class="toc-number">1.4.</span> <span class="toc-text">函数组件处理多状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#useState-%E5%8F%82%E6%95%B0%E4%B8%BA%E5%87%BD%E6%95%B0"><span class="toc-number">1.5.</span> <span class="toc-text">useState 参数为函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setState-%E6%98%AF%E5%90%8C%E6%AD%A5%E8%BF%98%E6%98%AF%E5%BC%82%E6%AD%A5"><span class="toc-number">1.6.</span> <span class="toc-text">setState 是同步还是异步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setState-%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%BA%E5%88%B6"><span class="toc-number">1.7.</span> <span class="toc-text">setState 的性能优化机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-number">1.7.1.</span> <span class="toc-text">思考</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#useEffect"><span class="toc-number">2.</span> <span class="toc-text">useEffect</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E9%A1%B9%E4%B8%BA%E7%A9%BA"><span class="toc-number">2.1.</span> <span class="toc-text">依赖项为空</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="toc-number">2.2.</span> <span class="toc-text">多个依赖项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#effect-%E7%AC%AC%E4%B8%80%E6%B8%B2%E6%9F%93%E4%B8%8D%E6%89%A7%E8%A1%8C%EF%BC%8C%E6%9B%B4%E6%96%B0%E7%9A%84%E6%97%B6%E5%80%99%E8%BF%90%E8%A1%8C-callback-%E8%BF%94%E5%9B%9E%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">2.3.</span> <span class="toc-text">effect 第一渲染不执行，更新的时候运行 callback 返回的函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#useEffect-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">2.4.</span> <span class="toc-text">useEffect 原理分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Error-1"><span class="toc-number">2.5.</span> <span class="toc-text">Error - 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Error-2"><span class="toc-number">2.6.</span> <span class="toc-text">Error - 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Error-3-%E5%BF%AB%E9%80%9F%E7%82%B9%E5%87%BB-btn-%E5%90%8E%EF%BC%8C%E6%A0%B7%E5%BC%8F%E6%88%96%E5%86%85%E5%AE%B9%E4%BC%9A%E6%9C%89%E7%9F%AD%E6%9A%82%E7%9A%84%E9%97%AA%E7%83%81"><span class="toc-number">2.7.</span> <span class="toc-text">Error-3 快速点击 btn 后，样式或内容会有短暂的闪烁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#useEffect-%E4%B8%8E-useLayoutEffect-%E5%8C%BA%E5%88%AB"><span class="toc-number">2.8.</span> <span class="toc-text">useEffect 与 useLayoutEffect 区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#useRef"><span class="toc-number">3.</span> <span class="toc-text">useRef</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://helenzhanglp.github.io/2023/06/15/React-Hooks/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&text=React Hooks"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&title=React Hooks"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&is_video=false&description=React Hooks"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=React Hooks&body=Check out this article: https://helenzhanglp.github.io/2023/06/15/React-Hooks/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&title=React Hooks"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&title=React Hooks"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&title=React Hooks"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&title=React Hooks"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://helenzhanglp.github.io/2023/06/15/React-Hooks/&name=React Hooks&description=&lt;p&gt;函数组件实现动态组件类组件的功能&lt;br&gt;React 最新版本 v18.2，Hook 是 React 16.8 新增特性。可以在不编写 class 的情况下使用 state 以及其他 React 特性。&lt;br&gt;引入 Hook 的动机——解决看起来不相关的问题&lt;br&gt;Hoos 是执行函数，产生函数上下文&lt;/p&gt;
&lt;h2 id=&#34;useState&#34;&gt;&lt;a href=&#34;#useState&#34; class=&#34;headerlink&#34; title=&#34;useState&#34;&gt;&lt;/a&gt;useState&lt;/h2&gt;&lt;p&gt;在函数组件中使用状态，并且后期基于状态修改，进而更新组件&lt;/p&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;/**&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; * initailValue 执行 useState 传递初始状态值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; * useState 返回一个数组，包括两个元素 [状态值，修改状态值的方法]&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; *  attribute 获取的状态值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; *  setAttribute 修改状态值的方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; *      setAttribute(value)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; *          修改状态值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; *          更新视图&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt; */&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;let&lt;/span&gt; [attribute, setAttribute] = &lt;span class=&#34;title function_&#34;&gt;useState&lt;/span&gt;(initailValue)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;Demo&#34;&gt;&lt;a href=&#34;#Demo&#34; class=&#34;headerlink&#34; title=&#34;Demo&#34;&gt;&lt;/a&gt;Demo&lt;/h3&gt;&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// 函数组件中使用状态，更新视图&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;default&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;Demo&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;let&lt;/span&gt; [num, setNum] = &lt;span class=&#34;title function_&#34;&gt;useState&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;title function_&#34;&gt;handleBtn&lt;/span&gt;(&lt;span class=&#34;params&#34;&gt;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;title function_&#34;&gt;setNum&lt;/span&gt;(++num)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// 函数组件不需要创建实例，没有 this&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;tag&#34;&gt;&amp;lt;&lt;span class=&#34;name&#34;&gt;Button&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;type&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;quot;primary&amp;quot;&lt;/span&gt; &lt;span class=&#34;attr&#34;&gt;onClick&lt;/span&gt;=&lt;span class=&#34;string&#34;&gt;&amp;#123;handleBtn&amp;#125;&lt;/span&gt;&amp;gt;&lt;/span&gt;按钮&amp;#123;num&amp;#125;&lt;span class=&#34;tag&#34;&gt;&amp;lt;/&lt;span class=&#34;name&#34;&gt;Button&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&#34;关于函数组件渲染更新&#34;&gt;&lt;a href=&#34;#关于函数组件渲染更新&#34; class=&#34;headerlink&#34; title=&#34;关于函数组件渲染更新&#34;&gt;&lt;/a&gt;关于函数组件渲染更新&lt;/h3&gt;&lt;pre class=&#34;mermaid&#34;&gt; flowchart TB
 subgraph ExcuteContext1
    subgraph 渲染EC1
        EC1[&#34;
            &lt;b style=&#34;color: #a33&#34;&gt;// 私有变量&lt;/b&gt;
            num = 0;
            setNum = function(){/* 修改状态函数 */};
            handle = function(){/* 事件处理函数 */}
        &#34;] --&gt; parse[编译JSX视图]
        parse --&gt; virtualDOM[创建VirtualDOM]
        virtualDOM --&gt; realDOM[&#34;创建真实DOM，页面渲染&#34;]
    end
    subgraph handle
         CLICK[&#34;
            &lt;b style=&#34;color: #a33&#34;&gt;// 私有变量&lt;/b&gt;
            setNum(++num) &lt;b style=&#34;color: #a33&#34;&gt;// 修改状态 + 更新视图&lt;/b&gt;
        &#34;] -.-&gt; EC1
    end
 end
 subgraph ExcuteContext2
    subgraph 更新EC2
        EC2[&#34;
            &lt;b style=&#34;color: #a33&#34;&gt;// 私有变量&lt;/b&gt;
            num = 1;
            setNum = function(){/* 修改状态函数 */};
            handle = function(){/* 事件处理函数 */}
        &#34;] --&gt; parse2[编译JSX视图]
        parse2 --&gt; virtualDOM2[创建VirtualDOM]
        virtualDOM2 --&gt;|&#34;diff 算法&#34;| realDOM2[&#34;创建真实DOM，页面渲染&#34;]
    end
    subgraph handle2
         CLICK2[&#34;
            &lt;b style=&#34;color: #a33&#34;&gt;// 私有变量&lt;/b&gt;
            setNum(++num) &lt;b style=&#34;color: #a33&#34;&gt;// 修改状态 + 更新视图&lt;/b&gt;
        &#34;] -.-&gt; EC2
    end
 end

 渲染EC1 --&gt;|&#34;重新执行DOM函数，产生新的函数执行上下文&#34;| 更新EC2&lt;/pre&gt;
&lt;h4 id=&#34;疑问&#34;&gt;&lt;a href=&#34;#疑问&#34; class=&#34;headerlink&#34; title=&#34;疑问&#34;&gt;&lt;/a&gt;疑问&lt;/h4&gt;&lt;p&gt;&lt;span class=&#34;custom-box custom-box-939&#34;&gt;点击按钮 3 秒钟之后，num 输出是几？？？&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;custom-box custom-box-393&#34;&gt;答案是 0。在 ExcuteContext1 作用域下，按照作用域链，访问的到的是 num = 0；不会访问 ExcuteContext2 作用域，所以 num 也不会为1。 &lt;/span&gt;&lt;/p&gt;"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

      
      <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2024
      Helen Zhang
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        
          <li><a href="/">
              Home
            </a></li>
          
          <li><a href="/about/">
              About
            </a></li>
          
          <li><a href="/archives/">
              Writing
            </a></li>
          
          <li><a href="/tags/">
              Tags
            </a></li>
          
          <li><a target="_blank" rel="noopener" href="https://github.com/HelenZhangLP">
              Projects
            </a></li>
          
      </ul>
    </nav>
  </div>
</footer>


  <!-- <script src='https://unpkg.com/mermaid@10.4.0/dist/mermaid.min.js'></script> -->
  <script src="https://cdn.bootcdn.net/ajax/libs/mermaid/10.4.0/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({ theme: 'default' });
    }
  </script>
  
      
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->

<!-- Disqus Comments -->


    </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
