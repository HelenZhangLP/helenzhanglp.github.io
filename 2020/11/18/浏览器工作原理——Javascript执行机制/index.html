<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="JavaScript代码执行顺序 先编译（编译出执行上下文（Execution context）与可执行代码）、后执行     代码编译阶段 var 声明的变量会产生 变量提升  JavaScript 执行上下文与调用栈 调用栈是用来管理函数调用关系的一种数据结构Maximum call stack exceeded  ES6 let 和 const 声明变量 var 会引起变量提升，变量提升产">
<meta property="og:type" content="article">
<meta property="og:title" content="浏览器工作原理——浏览器中的JavaScript执行机制">
<meta property="og:url" content="https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/index.html">
<meta property="og:site_name" content="魔女">
<meta property="og:description" content="JavaScript代码执行顺序 先编译（编译出执行上下文（Execution context）与可执行代码）、后执行     代码编译阶段 var 声明的变量会产生 变量提升  JavaScript 执行上下文与调用栈 调用栈是用来管理函数调用关系的一种数据结构Maximum call stack exceeded  ES6 let 和 const 声明变量 var 会引起变量提升，变量提升产">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/c0/a2/c0d303a289a535b87a6c445ba7f34fa2.png">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/ab/ce/abfba06cd23a7704a6eb148cff443ece.png">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/40/a8/40b8840480a5df4f43ad5f4e7907e3a8.png">
<meta property="article:published_time" content="2020-11-18T11:21:21.000Z">
<meta property="article:modified_time" content="2024-01-25T07:31:03.785Z">
<meta property="article:author" content="Helen Zhang">
<meta property="article:tag" content="browser">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="浏览器工作原理">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://static001.geekbang.org/resource/image/c0/a2/c0d303a289a535b87a6c445ba7f34fa2.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/logo.jpeg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/logo.jpeg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>浏览器工作原理——浏览器中的JavaScript执行机制</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">

    
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

    
<link rel="stylesheet" href="/css/style.css">

    <!-- rss -->
    
    
    <!-- jquery -->
    
<script src="/lib/jquery/jquery.min.js"></script>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>

<body>
    <div class="banner">
<div id="blogtitel" class="blogtitel">魔女</div>
<ul id="wrapper" class="wrapper">
  <div class="sun">
    <div class="star"></div>
  </div>
  <div class="mercury">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="venus">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="earth">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="mars">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="jupiter">
    <div class="planet"><div class="shadow"></div></div>
  </div>
</ul>
</div>

    <div class="background">
      
        <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i
      class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        
          <li><a href="/">
              Home
            </a></li>
          
          <li><a href="/about/">
              About
            </a></li>
          
          <li><a href="/archives/">
              Writing
            </a></li>
          
          <li><a href="/tags/">
              Tags
            </a></li>
          
          <li><a target="_blank" rel="noopener" href="https://github.com/HelenZhangLP">
              Projects
            </a></li>
          
      </ul>
    </span>
    <br />
    <span id="actions">
      <ul>
        
          <li><a class="icon" href="/2020/11/25/React-APIs/"><i class="fa fa-chevron-left" aria-hidden="true"
                onmouseover='$("#i-prev").toggle();' onmouseout='$("#i-prev").toggle();'></i></a></li>
          
            
              <li><a class="icon" href="/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93/"><i class="fa fa-chevron-right"
                    aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a>
              </li>
              
                <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i
                      class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();'
                      onmouseout='$("#i-top").toggle();'></i></a></li>
                <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true"
                      onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();'
                      onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br />
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&text=浏览器工作原理——浏览器中的JavaScript执行机制"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=浏览器工作原理——浏览器中的JavaScript执行机制"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&is_video=false&description=浏览器工作原理——浏览器中的JavaScript执行机制"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=浏览器工作原理——浏览器中的JavaScript执行机制&body=Check out this article: https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=浏览器工作原理——浏览器中的JavaScript执行机制"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=浏览器工作原理——浏览器中的JavaScript执行机制"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=浏览器工作原理——浏览器中的JavaScript执行机制"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=浏览器工作原理——浏览器中的JavaScript执行机制"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&name=浏览器工作原理——浏览器中的JavaScript执行机制&description=&lt;blockquote&gt;
&lt;h3 id=&#34;JavaScript代码执行顺序&#34;&gt;&lt;a href=&#34;#JavaScript代码执行顺序&#34; class=&#34;headerlink&#34; title=&#34;JavaScript代码执行顺序&#34;&gt;&lt;/a&gt;&lt;a href=&#34;#codeExecutionOrder&#34;&gt;JavaScript代码执行顺序&lt;/a&gt;&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;先编译（&lt;u&gt;编译出&lt;strong&gt;执行上下文（Execution context）&lt;/strong&gt;与可执行代码&lt;/u&gt;）、后执行&lt;br&gt;     代码编译阶段 var 声明的变量会产生 &lt;strong&gt;变量提升&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;JavaScript-执行上下文与调用栈&#34;&gt;&lt;a href=&#34;#JavaScript-执行上下文与调用栈&#34; class=&#34;headerlink&#34; title=&#34;JavaScript 执行上下文与调用栈&#34;&gt;&lt;/a&gt;&lt;a href=&#34;#callStack&#34;&gt;JavaScript 执行上下文与调用栈&lt;/a&gt;&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;u&gt;调用栈是用来管理函数调用关系的一种&lt;strong&gt;数据结构&lt;/strong&gt;&lt;code&gt;Maximum call stack exceeded&lt;/code&gt;&lt;/u&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;ES6-let-和-const-声明变量&#34;&gt;&lt;a href=&#34;#ES6-let-和-const-声明变量&#34; class=&#34;headerlink&#34; title=&#34;ES6 let 和 const 声明变量&#34;&gt;&lt;/a&gt;&lt;a href=&#34;#letAndConst&#34;&gt;ES6 let 和 const 声明变量&lt;/a&gt;&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;var 会引起变量提升，变量提升产生变量污染、消耗一部分无用的内存。&lt;br&gt;     var 声明变量引起变量提升——容易在无意识的情况下变量覆盖&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;通过 let 和 const 解决变量提升，ECMAScript6 中，提出的 let 和 const 有块级作用域的概念。很好的解决了变量提升的问题&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
&lt;li&gt;&lt;input disabled type=&#34;checkbox&#34;&gt; 作用域链与闭包&lt;ul&gt;
&lt;li&gt;作用域变量的有效性和生命周期&lt;/li&gt;
&lt;li&gt;闭包嵌套函数，内部引用外出变量，外部函数执行结束后，不能完全退栈。内部函数存在外部函数的变量引用&lt;/li&gt;
&lt;li&gt;this 与变量不同，内部函数不能继承外部函数的 this。解决办法有三种：&lt;ol&gt;
&lt;li&gt;this 转换为作用域，将 this 赋值给变量，内部函数访问 this 赋值的变量；&lt;/li&gt;
&lt;li&gt;箭头函数继承上一级的 this&lt;/li&gt;
&lt;li&gt;采用 call/apply/bind 其一，进行对象冒充&lt;/li&gt;
&lt;li&gt;传参&lt;span id=&#34;more&#34;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;1-JavaScript-代码的执行顺序&#34;&gt;&lt;a href=&#34;#1-JavaScript-代码的执行顺序&#34; class=&#34;headerlink&#34; title=&#34;1. JavaScript 代码的执行顺序&#34;&gt;&lt;/a&gt;&lt;a name=&#34;codeExecutionOrder&#34;&gt;1. JavaScript 代码的执行顺序&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;JavaScript 代码是&lt;strong&gt;按顺序执行&lt;/strong&gt;的&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;分析以下代码&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable language_&#34;&gt;console&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;log&lt;/span&gt;(name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable language_&#34;&gt;console&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;log&lt;/span&gt;(undefinedvariable)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; name; &lt;span class=&#34;comment&#34;&gt;// 声明&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;name = &lt;span class=&#34;number&#34;&gt;123&lt;/span&gt;; &lt;span class=&#34;comment&#34;&gt;// 赋值部分&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;/*&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;  undefined&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;  Uncaught ReferenceError: undefinedvariable is not defined&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;    at &amp;lt;anonymous&amp;gt;:2:13&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;变量 name 后定义，提前使用打印或undefined，未声明变量 undefinedvariable 报错 is not defined，怎么理解&lt;/p&gt;
&lt;h3 id=&#34;1-1-认识变量提升（Hoisting）&#34;&gt;&lt;a href=&#34;#1-1-认识变量提升（Hoisting）&#34; class=&#34;headerlink&#34; title=&#34;1-1. 认识变量提升（Hoisting）&#34;&gt;&lt;/a&gt;1-1. 认识变量提升（Hoisting）&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;del&gt;JavaScript 代码执行过程中，JavaScript 引擎把变量声明部分和函数声明部分提升到代码开头的行为&lt;/del&gt;&lt;code&gt;JavaScript 代码在编译过程中，被 JavaScript 引擎放入内存的行为&lt;/code&gt;，叫做 &lt;strong&gt;变量提升&lt;/strong&gt;。&lt;/p&gt;
&lt;/blockquote&gt;"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#JavaScript%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.</span> <span class="toc-text">JavaScript代码执行顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JavaScript-%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E4%B8%8E%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-number">2.</span> <span class="toc-text">JavaScript 执行上下文与调用栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ES6-let-%E5%92%8C-const-%E5%A3%B0%E6%98%8E%E5%8F%98%E9%87%8F"><span class="toc-number">3.</span> <span class="toc-text">ES6 let 和 const 声明变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-JavaScript-%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number"></span> <span class="toc-text">1. JavaScript 代码的执行顺序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E8%AE%A4%E8%AF%86%E5%8F%98%E9%87%8F%E6%8F%90%E5%8D%87%EF%BC%88Hoisting%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">1-1. 认识变量提升（Hoisting）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%88%86%E6%9E%90%E4%BB%A3%E7%A0%81%E4%BA%86%E8%A7%A3%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">1-2. 分析代码了解代码执行环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#demo-1-1-%E5%88%86%E6%9E%90%E4%BB%A5%E4%B8%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">2.1.</span> <span class="toc-text">demo-1-1 分析以下代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#demo-1-2-%E5%88%86%E6%9E%90%E4%BB%A5%E4%B8%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.</span> <span class="toc-text">demo-1-2.  分析以下代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-JavaScript-%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E4%B8%8E%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-number"></span> <span class="toc-text">2. JavaScript 执行上下文与调用栈</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-number">1.</span> <span class="toc-text">2-1. 调用栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-demo-%E5%88%86%E6%9E%90%E4%BB%A3%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">2-1-demo. 分析代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chrome-%E5%BC%80%E5%8F%91%E8%80%85%E5%B7%A5%E5%85%B7%E6%9F%A5%E7%9C%8B%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-number">3.</span> <span class="toc-text">chrome 开发者工具查看调用栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%A0%88%E6%BA%A2%E5%87%BA%EF%BC%88stack-overflow"><span class="toc-number">4.</span> <span class="toc-text">3. 栈溢出（stack overflow)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%A0%88%E6%BA%A2%E5%87%BA"><span class="toc-number">4.1.</span> <span class="toc-text">解决栈溢出</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-JavaScript-let-const-%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E"><span class="toc-number"></span> <span class="toc-text">4. JavaScript let const 变量声明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%8F%98%E9%87%8F%E6%8F%90%E5%8D%87%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">4-1 变量提升带来的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-%E5%AE%B9%E6%98%93%E5%9C%A8%E6%97%A0%E6%84%8F%E8%AF%86%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96"><span class="toc-number">1.1.</span> <span class="toc-text">4-1-1. 容易在无意识的情况下变量覆盖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-%E5%8F%98%E9%87%8F%E6%9C%AA%E8%83%BD%E5%8F%8A%E6%97%B6%E9%94%80%E6%AF%81"><span class="toc-number">1.2.</span> <span class="toc-text">4-1-2. 变量未能及时销毁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E9%80%9A%E8%BF%87-let-const-JavaScript%E5%9D%97%E7%BA%A7%E4%BD%9C%E7%94%A8%E5%9F%9F-%E8%A7%A3%E5%86%B3%E5%8F%98%E9%87%8F%E6%8F%90%E5%8D%87%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">4-2. 通过 let&#x2F;const + JavaScript块级作用域 解决变量提升的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-%E4%BD%9C%E7%94%A8%E5%9F%9F%EF%BC%88scope%EF%BC%89"><span class="toc-number">2.1.</span> <span class="toc-text">4-2-1.  作用域（scope）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-%E8%A7%A3%E5%86%B3%E5%8F%98%E9%87%8F%E6%8F%90%E5%8D%87%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.</span> <span class="toc-text">4-2-2. 解决变量提升的问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-ES6-%E6%80%8E%E4%B9%88%E5%85%BC%E5%AE%B9%E5%8F%98%E9%87%8F%E6%8F%90%E5%8D%87%E5%92%8C%E5%9D%97%E7%BA%A7%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9A%84"><span class="toc-number"></span> <span class="toc-text">4-3. ES6 怎么兼容变量提升和块级作用域的</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Uncaught-ReferenceError-Cannot-access-%E2%80%98myname%E2%80%99-before-initialization"><span class="toc-number">0.1.</span> <span class="toc-text">Uncaught ReferenceError: Cannot access ‘myname’ before initialization</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E4%BD%9C%E7%94%A8%E5%9F%9F%E9%93%BE"><span class="toc-number"></span> <span class="toc-text">5. 作用域链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E8%AF%8D%E6%B3%95%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-number">1.</span> <span class="toc-text">6-1. 词法作用域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%9D%97%E7%BA%A7%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9A%84%E5%8F%98%E9%87%8F%E6%9F%A5%E6%89%BE"><span class="toc-number">2.</span> <span class="toc-text">6-2. 块级作用域的变量查找</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E9%97%AD%E5%8C%85"><span class="toc-number"></span> <span class="toc-text">7. 闭包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E9%97%AD%E5%8C%85%E6%80%8E%E4%B9%88%E5%9B%9E%E6%94%B6"><span class="toc-number">1.</span> <span class="toc-text">7-1.  闭包怎么回收</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-JavaScript-%E4%B8%AD%E7%9A%84-this-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number"></span> <span class="toc-text">8. JavaScript 中的 this 是什么</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%85%A8%E5%B1%80%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87-this"><span class="toc-number">1.</span> <span class="toc-text">8-1.  全局执行上下文 this</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87-this"><span class="toc-number">2.</span> <span class="toc-text">8-2.  函数执行上下文 this</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E8%AE%BE%E7%BD%AE%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87-this-%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">8-3.  设置执行上下文 this 的几种方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-this-%E7%9A%84%E8%AE%BE%E8%AE%A1%E7%BC%BA%E9%99%B7%E5%8F%8A%E5%BA%94%E5%AF%B9%E6%96%B9%E6%A1%88"><span class="toc-number">4.</span> <span class="toc-text">8-4.  this 的设计缺陷及应对方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E5%85%B3%E4%BA%8E-this-%E7%9A%84-demo-%E5%88%86%E6%9E%90"><span class="toc-number"></span> <span class="toc-text">9 关于 this 的 demo 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">解决办法：</span></a></li></ol>
    </div>
  </span>
</div>
      
      <div class="content index width mx-auto px2 my4">
          
          <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="header">
    
    <h1 class="posttitle" itemprop="name headline">
        浏览器工作原理——浏览器中的JavaScript执行机制
    </h1>



      <div class="meta">
        <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <span itemprop="name">
            魔女
                    
          </span>
        </span>
        
    <div class="postdate">
        <time datetime="2020-11-18T11:21:21.000Z" itemprop="datePublished">2020-11-18</time>
    </div>


          
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/browser/" rel="tag">browser</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/" rel="tag">浏览器工作原理</a></li></ul>

      </div>
  </header>
  

    <div class="content" itemprop="articleBody">
      <blockquote>
<h3 id="JavaScript代码执行顺序"><a href="#JavaScript代码执行顺序" class="headerlink" title="JavaScript代码执行顺序"></a><a href="#codeExecutionOrder">JavaScript代码执行顺序</a></h3><blockquote>
<p>先编译（<u>编译出<strong>执行上下文（Execution context）</strong>与可执行代码</u>）、后执行<br>     代码编译阶段 var 声明的变量会产生 <strong>变量提升</strong></p>
</blockquote>
<h3 id="JavaScript-执行上下文与调用栈"><a href="#JavaScript-执行上下文与调用栈" class="headerlink" title="JavaScript 执行上下文与调用栈"></a><a href="#callStack">JavaScript 执行上下文与调用栈</a></h3><blockquote>
<p><u>调用栈是用来管理函数调用关系的一种<strong>数据结构</strong><code>Maximum call stack exceeded</code></u></p>
</blockquote>
<h3 id="ES6-let-和-const-声明变量"><a href="#ES6-let-和-const-声明变量" class="headerlink" title="ES6 let 和 const 声明变量"></a><a href="#letAndConst">ES6 let 和 const 声明变量</a></h3><blockquote>
<p>var 会引起变量提升，变量提升产生变量污染、消耗一部分无用的内存。<br>     var 声明变量引起变量提升——容易在无意识的情况下变量覆盖</p>
</blockquote>
</blockquote>
<ul>
<li>通过 let 和 const 解决变量提升，ECMAScript6 中，提出的 let 和 const 有块级作用域的概念。很好的解决了变量提升的问题</li>
</ul>
<ul>
<li><input disabled="" type="checkbox"> 作用域链与闭包<ul>
<li>作用域变量的有效性和生命周期</li>
<li>闭包嵌套函数，内部引用外出变量，外部函数执行结束后，不能完全退栈。内部函数存在外部函数的变量引用</li>
<li>this 与变量不同，内部函数不能继承外部函数的 this。解决办法有三种：<ol>
<li>this 转换为作用域，将 this 赋值给变量，内部函数访问 this 赋值的变量；</li>
<li>箭头函数继承上一级的 this</li>
<li>采用 call/apply/bind 其一，进行对象冒充</li>
<li>传参<span id="more"></span></li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="1-JavaScript-代码的执行顺序"><a href="#1-JavaScript-代码的执行顺序" class="headerlink" title="1. JavaScript 代码的执行顺序"></a><a name="codeExecutionOrder">1. JavaScript 代码的执行顺序</a></h2><p>JavaScript 代码是<strong>按顺序执行</strong>的</p>
<blockquote>
<p>分析以下代码</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(name)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(undefinedvariable)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> name; <span class="comment">// 声明</span></span><br><span class="line">name = <span class="number">123</span>; <span class="comment">// 赋值部分</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  undefined</span></span><br><span class="line"><span class="comment">  Uncaught ReferenceError: undefinedvariable is not defined</span></span><br><span class="line"><span class="comment">    at &lt;anonymous&gt;:2:13</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>变量 name 后定义，提前使用打印或undefined，未声明变量 undefinedvariable 报错 is not defined，怎么理解</p>
<h3 id="1-1-认识变量提升（Hoisting）"><a href="#1-1-认识变量提升（Hoisting）" class="headerlink" title="1-1. 认识变量提升（Hoisting）"></a>1-1. 认识变量提升（Hoisting）</h3><blockquote>
<p><del>JavaScript 代码执行过程中，JavaScript 引擎把变量声明部分和函数声明部分提升到代码开头的行为</del><code>JavaScript 代码在编译过程中，被 JavaScript 引擎放入内存的行为</code>，叫做 <strong>变量提升</strong>。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(name)</span><br><span class="line"><span class="title function_">fn</span>();</span><br><span class="line"><span class="title function_">fn_var</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> name; <span class="comment">// 声明</span></span><br><span class="line">name = <span class="number">123</span>; <span class="comment">// 赋值部分</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;完整的函数声明&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fn_var = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;匿名函数赋值给变量&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 完整的函数声明</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    VM791:3 Uncaught TypeError: fn_var is not a function</span></span><br><span class="line"><span class="comment">    at &lt;anonymous&gt;:3:1</span></span><br><span class="line"><span class="comment">    (anonymous) @ VM791:3</span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>分析：<br>  console.log(name) 打印出 undefined 变量提升后，会给变量设置默认值 undefined。<br>  fn() 执行后打印 完整的函数声明<br>  fn_var() <code>Uncaught TypeError: fn_var is not a function</code> 因为 fn_var 是变量，提升后相当于 <code>fn_var = undefined</code>，所以报错，fn_var 不是一个函数。</p>
</blockquote>
<p><font color="red"><strong>JavaScript 代码的执行流程</strong></font></p>
<pre class="mermaid">  graph LR;
  JavaScriptCode --> 编译;
  编译 --> 执行;</pre>

<h3 id="1-2-分析代码了解代码执行环境"><a href="#1-2-分析代码了解代码执行环境" class="headerlink" title="1-2. 分析代码了解代码执行环境"></a>1-2. 分析代码了解代码执行环境</h3><blockquote>
<p><strong>执行上下文</strong> javaScript 执行一段代码时的 <strong>运行环境</strong>。<br>执行上下文中存在一个变量环境的对象（Variable Environment)，variable Environment 中保存了变量提升的内容</p>
</blockquote>
<h4 id="demo-1-1-分析以下代码"><a href="#demo-1-1-分析以下代码" class="headerlink" title="demo-1-1 分析以下代码"></a>demo-1-1 分析以下代码</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&quot;variable promotion&quot;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showName</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> name = <span class="string">&quot;variable promotion case&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">showName</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// undefined</span></span><br><span class="line"><span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>

<p>如上代码，<code>编译后会将会将提升的变量 name=undefined; function showName()&#123;...&#125;保存在变量环境中</code>，如下图</p>
<img  src=http://www.plantuml.com/plantuml/svg/AqfDBadCIyz9LL02GkMSpBnKlPJyafBK58LgBWM5vCIY50MbPvtBNopiURAZwycExcVJsk7g4eipKbEiGMohf9pILEkIr8eI20kiMK6X26xwq_uPBzlxd_UjVxgeMK4vCISpETK9f12isISpFQCaEBlI2Mv8PbvAPdg-GZJO50K5coGxP0Diz9Fie39wG01bvYNcfjgMvgMafW7DJB66YgQLvYMNPERdAHHdv9Vx0PLeQ5O3zTI2fME1P2tCcwaLgScb8ANE-Icf2ieU-NcfbIcfvKXET2zAJSs3E30Tn8Iw3-owzT10shtu-O96k0FXpaFORgr00711t8KIOhhHoYL5YNd51Ob5gNabiRfsgAxbgWK0>

<h4 id="demo-1-2-分析以下代码"><a href="#demo-1-2-分析以下代码" class="headerlink" title="demo-1-2.  分析以下代码"></a>demo-1-2.  分析以下代码</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">showName</span>();</span><br><span class="line"><span class="keyword">var</span> showName = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>VM4235:1 Uncaught TypeError: showName is not a function</p>
</blockquote>
<ul>
<li>编译阶段：全局执行上下文环境变量 <code>showName = undefined</code> 写入内存，可执行代码 <code>showName()</code></li>
<li>执行阶段：代码按顺序执行，先执行第一行 <code>showName()</code>，环境变量中存在 showName，值是 undefined，并不是一个函数。所以报错 <code>showName is not a function</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">showName</span>();</span><br><span class="line"><span class="keyword">var</span> showName = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showName</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>打印出 2</p>
</blockquote>
<ul>
<li>编译阶段：第一行 <code>showName()</code> 放入可执行代码；第二行声明变量 showName 放入全局执行上下文 <code>showName = undefined</code>；第 五 行 <code>覆盖 showName 赋值 function 引用</code></li>
<li>执行阶段变量环境中找到 <code>函数 showName</code>，打印结果 2，showName 再次赋值 <code>function() &#123; console.log(1) &#125;</code>的引用。下次再执行 showName() 打印结果是 1</li>
</ul>
<h2 id="2-JavaScript-执行上下文与调用栈"><a href="#2-JavaScript-执行上下文与调用栈" class="headerlink" title="2. JavaScript 执行上下文与调用栈"></a><a name="callStack">2. JavaScript 执行上下文与调用栈</a></h2><p>代码编译阶段可创建三种执行上下文：</p>
<ol>
<li> 当 JavaScript 执行全局代码的时候，会编译全局代码并创建 <strong>全局执行上下文</strong>。<font color="red">整个页面的生命周期内，全局执行上下文只有一份</font>；</li>
<li> 当调用一个函数时，函数体内的代码会被编译，并创建 <strong>函数执行上下文</strong>，<font color="red">一般情况下，函数执行结束后，创建的函数执行上下文被销毁</font>；</li>
<li> 当使用 eval 函数的时候，eval 代码也会被编译，并创建执行上下文。</li>
</ol>
<h3 id="2-1-调用栈"><a href="#2-1-调用栈" class="headerlink" title="2-1. 调用栈"></a>2-1. 调用栈</h3><blockquote>
<p><strong><code>调用栈用来管理函数调用关系的一种数据结构。</code></strong></p>
</blockquote>
<p>栈容器、入栈、出栈<br>栈中元素后进先出。<br>JavaScript 引擎创建执行上下文，然后压入<strong>调用栈</strong></p>
<img  src=http://www.plantuml.com/plantuml/svg/Aov9JCvMUB6X-VcK5SyMT2XKSoae5AKcboJcfUUaAYWzRT_xREg6PvtBNopiURAZwycExcVJsfKKb7CoyrBrKl9BIb9Jm5gmQ7hQF-DbU__pllLF5pK3TIJcP2QdEkMKfbgNf5QKM6NcfMIcvrk3pB7ooKpFA0dEhWJ9OZVhnVhUPvkdmitopImkgGpAByPYLd1YJcv-7j2KMZIFjAvukh61L8-0DP7d4MliXg7v91VaaoAiFYb6zWdMU53GqujMBYbAp2ikI2nApIk9LS3gIowkMW00>

<p><strong>调用栈是 JavaScript 引擎追踪函数执行的一个机制。<font color="red">多个函数被调用时，通过调用栈可以追踪到哪个函数正在被执行以及各个函数之间的调用关系</font></strong></p>
<h3 id="2-1-demo-分析代码"><a href="#2-1-demo-分析代码" class="headerlink" title="2-1-demo. 分析代码"></a>2-1-demo. 分析代码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;helen zhang&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showName</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">callShowName</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> name = <span class="string">&#x27;call helen zhang&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">showName</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">callShowName</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<img  src=http://www.plantuml.com/plantuml/svg/bPExJiCm58RtFiLH6MWhKVOcP031X5WOgmwkOz88OoF7uQfAI0YLcq18K5LCm08Jbm5KeV0sJLgclW9ksaO9b5i6Ayh_dtFoVxOTYV0of3kFk-tpk-1gFmtRAG11i4JCeWJIVkqjk7XqAdnz0QsGuE2sSttSQXwscaT1lPO6vC1GWp5gCv8tkPJ43Di0O2HCM4F2HcLAPjcQBJXR8KpESR4ObI5gOp9DNQBr6XJcRQiY5vStmo-IRCY2pKpRub0CMmBePIEQwPystckdxPC7_sPt8EVLCtZ5d3cSaZpbLWOZIeSpiw5UKcjrLDguTLJYkFxFr3E9qa_9wH-I9sR_d9ufozHuhm0gX186MnKLSrp7d79H4CGqTDVeUljjhzvvE7jll0JtprtlCgm3VyThDL_1PIPPKlzcThq3VT8rzCcmslWMuDwT_xGp2ff5UHdHsGs2NQauSDOB-1zw0rpbNt5f4QzShi-cpocN-uvH78-ceCGGPU9q-lQ8YGRze74nqIixnDL3ztNuaikmj3cBhb0ckwtKglQ3DRx_0tjiBzGINOs9ufWKY3chI2XwfOd4qKb1yXH_CO_ShbJr0m00>
<blockquote>
<p>分析：</p>
</blockquote>
<ol>
<li><strong>编译</strong><br> JavaScript 引擎编译代码创建变量name=undefined, 声明函数 callShowName，声明函数showName, <strong>全局执行上下文</strong> 压入栈；<br> <strong>执行</strong><br> name 赋值 helen zhang<br> 执行调用 callShowName 函数</li>
<li><strong>编译</strong><br> 声明变量 name 赋值 undefined，创建 <strong>callShowName函数执行上下文</strong>，并压入栈：<br> 执行 callName 赋值 ‘undefined’<br> showName() 放入执行代码<br> <strong>执行</strong><br> 调用 showName()</li>
<li><strong>编译</strong><br> 创建 <strong>showName函数执行上下文</strong><br> <strong>执行</strong><br> console.log(callShowName) 打印 callShowName</li>
</ol>
<p>以上创建的两个执行上下文是通过 <strong>栈数据结构</strong> 来管理的。</p>
<h3 id="chrome-开发者工具查看调用栈"><a href="#chrome-开发者工具查看调用栈" class="headerlink" title="chrome 开发者工具查看调用栈"></a>chrome 开发者工具查看调用栈</h3><ol>
<li>javascript 代码打断点（debugger）</li>
<li>执行时进入断点</li>
<li>开发者工具右侧 call stack 查看调用栈</li>
</ol>
<p><img src="https://static001.geekbang.org/resource/image/c0/a2/c0d303a289a535b87a6c445ba7f34fa2.png" alt="chrome 调用栈"><br>anonymous 全局函数入口<br>中间是 addAll 函数<br>顶部是 add 函数<br>在分析复杂代码结构时，或检查 bug 时，调用栈非常有用<br>runStack 当前调用函数</p>
<p><strong><code>console.trace() 输出函数调用关系</code></strong><br><img src="https://static001.geekbang.org/resource/image/ab/ce/abfba06cd23a7704a6eb148cff443ece.png" alt="console.trace"></p>
<h3 id="3-栈溢出（stack-overflow"><a href="#3-栈溢出（stack-overflow" class="headerlink" title="3. 栈溢出（stack overflow)"></a>3. 栈溢出（stack overflow)</h3><p><code>调用栈有大小的</code>，超出后 JavaScript 引擎会报错<code>超出最大栈调用大小（Maximum call stack size exceeded）</code>，<strong>栈溢出</strong></p>
<blockquote>
<p>递归没有任何终止条件的函数，会一直创建执行上下文，并反复压入栈中，栈容量有限，超过最大数量后会出现 <code>Maximum call stack size exceeded</code></p>
</blockquote>
<h4 id="解决栈溢出"><a href="#解决栈溢出" class="headerlink" title="解决栈溢出"></a>解决栈溢出</h4><p>递归调用的形式改造成其他形式，或者使用加入定时器的方法来把当前任务拆分为其他很多小任务来解决栈溢出</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">runStack</span> (n) &#123;</span><br><span class="line">  <span class="keyword">if</span> (n === <span class="number">0</span>) <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">runStack</span>( n- <span class="number">2</span>)</span><br><span class="line">  &#125;,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">runStack</span>(<span class="number">50000</span>)</span><br></pre></td></tr></table></figure>

<h2 id="4-JavaScript-let-const-变量声明"><a href="#4-JavaScript-let-const-变量声明" class="headerlink" title="4. JavaScript let const 变量声明"></a><a name="letAndConst">4. JavaScript let const 变量声明</a></h2><p>var 声明的变量会有 <strong>变量提升</strong> 的特性，与直觉不否。javaScript 语言最初用最快速、最简单的方式设计，所以没有块级作用域，把块级作用域内部的变量提升。变量提升后，在编译阶段都会被提取到执行上下文的变量环境中，所以亦是可以在声明前调用。这是 JavaScript 的一个重要的设计缺陷。由于 JavaScript 需要保持向下兼容，所以变量提升特性还会继续存在</p>
<h3 id="4-1-变量提升带来的问题"><a href="#4-1-变量提升带来的问题" class="headerlink" title="4-1 变量提升带来的问题"></a>4-1 变量提升带来的问题</h3><h4 id="4-1-1-容易在无意识的情况下变量覆盖"><a href="#4-1-1-容易在无意识的情况下变量覆盖" class="headerlink" title="4-1-1. 容易在无意识的情况下变量覆盖"></a><font color="red">4-1-1. 容易在无意识的情况下变量覆盖</font></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&quot;variable promotion&quot;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showName</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> name = <span class="string">&quot;variable promotion case&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">showName</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// undefined</span></span><br><span class="line"><span class="comment">// variable promotion case</span></span><br></pre></td></tr></table></figure>
<p>以上代码执行结果，打印 undefined 和 variable promotion case，结合下图继续分析</p>
<img  src=http://www.plantuml.com/plantuml/svg/fPCzJyCm48Rt_efJki3GihSb0ymmqB7gu3fkQjMnAzk1LgWIY04XFZeXLKny36nqG6MXFuVqO-8laAG99BIYbSXWdSw-z-xUHr4QuIOO6346AeWDECu0I88ruZOZO90smQwcWWCMN9Es1b47cuaQOWOW5OMxqLsMKKxobj2QMA4I04RI0g_Ndvtt9ZS3x_4CieXHJ7QOIuh1ymAZTaENcvqm4yWKABUeBQ0I2W2KQcPI8Chc_IyAENB8jiijKlVrh6892oPaGHBB_7X_cjoVZY-UfmzNi_xR-6Ku7Lvw9wFFqTqXaXJL_1rRKZWYMB6q5HQQYmrKGnpj-qqsDfFYNcymLvvtIPLNm_F7oEdWUlnw6pkmHvNk70YLsdVkHXanntSxiNkoz5kxkmQckijnc8l73ud5sLNCug9_iricj8hX6WWN-VbpA_8dXNYKD0qde27NfB5C8aNbjx-vIbPBn5KBIS9rDMUc_vbCzmi0>

<blockquote>
<p>分析</p>
</blockquote>
<ol>
<li> 全局执行上下文压入栈以后，JavaScript 引擎开始执行全局代码。</li>
<li> name 变量赋值 variable promotion，再调用函数showName`</li>
</ol>
<p><strong>调用函数时，javascript 引擎编译该函数，为其创建执行上下文，再将执行上下文压入栈</strong><br>函数执行上下文压入栈后，JavaScript 引擎再从上到下执行showName函数代码，执行到第一个 console.log(name)取编译时的初值 undefined 打印出 undefined，（<font color="red">与目标打印出 variable promotion 不同，原因是变量提升，导致变量覆盖</font>）第二个 console.log(name) 时，因没有块级作用域，所以打印出 variable promotion case</p>
<h4 id="4-1-2-变量未能及时销毁"><a href="#4-1-2-变量未能及时销毁" class="headerlink" title="4-1-2. 变量未能及时销毁"></a><font color="red">4-1-2. 变量未能及时销毁</font></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">variableDestruction</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)&#123;&#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">variableDestruction</span>();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>分析</p>
</blockquote>
<ol>
<li> JavaScript 编译以上代码，生成全局上下文(环境变量 function variableDestruction(){…})，压入栈内存中。</li>
<li> JavaScript 执行可执行代码 <code>variableDestruction()</code>，创建函数执行上下文(环境变量 i=undefined)，再将函数执行上下文 压入栈内存。</li>
<li>javascript 引擎继续执行可执行代码 i 赋值、遍历、打印结果是 5。<br><font color="red"><strong>因为没有块级作用域，导致遍历结果后没有销毁变量i,所以打印结果是 5</strong></font></li>
</ol>
<h3 id="4-2-通过-let-const-JavaScript块级作用域-解决变量提升的问题"><a href="#4-2-通过-let-const-JavaScript块级作用域-解决变量提升的问题" class="headerlink" title="4-2. 通过 let/const + JavaScript块级作用域 解决变量提升的问题"></a>4-2. 通过 <code>let/const + JavaScript块级作用域</code> 解决变量提升的问题</h3><h4 id="4-2-1-作用域（scope）"><a href="#4-2-1-作用域（scope）" class="headerlink" title="4-2-1.  作用域（scope）"></a>4-2-1.  作用域（scope）</h4><blockquote>
<p><font color="red">作用域</font>程序中定义变量的区域，该<u>位置决定了变量的生命周期</u>。作用域是变量与函数的可访问范围，<u>作用域控制着变量和函数的<strong>可见性</strong>和<strong>生命周期</strong></u>。</p>
</blockquote>
<ol>
<li> <strong>全局作用域</strong> 中的对象在代码中任何地方都能访问，<u>其生命周期为整个页面的生命周期</u>；</li>
<li> <strong>函数作用域</strong> 函数内部定义的变量或者函数，<strong>只能在函数内部访问</strong>。<u>其生命周期从函数调用到函数执行结束。</u>函数执行结束，函数内部定义的变量销毁。</li>
<li> <strong>块级作用域</strong> —— 即使用一对大括号包裹的代码，如：函数、判断语句、循环语句等。 <font color="red"><code>ES6 之后引入了 let/const 声明关键字，使得 JavaScript 也能像其它语言一样拥有块级作用域了。</code></font></li>
</ol>
<h4 id="4-2-2-解决变量提升的问题"><a href="#4-2-2-解决变量提升的问题" class="headerlink" title="4-2-2. 解决变量提升的问题"></a>4-2-2. 解决变量提升的问题</h4><p>ECMAScript6 以前<u>没有如{}，判断语句，循环语句的块级作用域，</u><strong>ES6 引入 let 和 const 关键字</strong>，因为 let 和 const 声明的变量是有块级作用的概念的</p>
<blockquote>
<p>let 声明的变量可以被修改，const 声明的变量不可以。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">variableDestruction</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;&#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">variableDestruction</span>();</span><br></pre></td></tr></table></figure>
<blockquote>
<p><font color="red">Uncaught ReferenceError: i is not defined</font> 说明块级作用域生效，i 在 块级作用域以外不能访问。也就是在函数作用域内没有变量提升。</p>
</blockquote>
<h2 id="4-3-ES6-怎么兼容变量提升和块级作用域的"><a href="#4-3-ES6-怎么兼容变量提升和块级作用域的" class="headerlink" title="4-3. ES6 怎么兼容变量提升和块级作用域的"></a>4-3. ES6 怎么兼容变量提升和块级作用域的</h2><p>块级作用域是通过词法环境的栈结构实现的，变量提升是通过变量环境实现的，两者结合，JavaScript 引擎就同时支持了变量提升和块级作用域<br>从上下文的角度分析：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> b = <span class="number">2</span>;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">let</span> b = <span class="number">3</span>, d = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">var</span> c = <span class="number">4</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(b)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(b)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(c)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(d)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>()</span><br></pre></td></tr></table></figure>
<p><strong>1.  编译并创建执行上下文</strong></p>
<img  src=http://www.plantuml.com/plantuml/svg/AqfDBadCIyz9LKZBSyxFAqcjA558B5PGIilFLtZQllVPr0tFEfU_MDZpP4VNantTpwQrAoaevsJcfUgbv9UKfAOeL7CfA1J1pSX9hSXCJinnpIlBBChFoqtDAr5GziqiBgaCoYzEjGOPRfMPbvAPdcyDCiCgE34dDpzF8HfeXeA2JPBTY_MzppPFVTwt_kcYPh2O7X206KcsfNafgMb0JIb0VYoAfMM9HPc9IJcfABOcvcGcfphbbAP2RFB9JCye2Swk18iWkGDgjvRMq_uPBzlx8LPhQS4jXzYUYB3T6jLToQWoiLor0000>
<blockquote>
<p>解析</p>
</blockquote>
<ul>
<li>函数内部 var 声明的变量，编译时存入 <strong>变量环境</strong></li>
<li>let 声明的变量，编译时存入 <strong>词法环境（Lexical Environment）</strong></li>
<li>函数内部的块级作用域内部，通过 let 声明的变量编译阶段未放到词法环境中</li>
</ul>
<p><strong>2.  执行代码</strong></p>
<img  src=http://www.plantuml.com/plantuml/svg/TOyzJm9148PxViK4kYqmO7Tm51exEqj3iTpEdHkNtMHl8H1ZPN7naqRKGaEqmGuJ6sB2lxaF_1VUNUB5GvrcP_A--yuy6Xr3fISGNBchfC6H0Uf3rLKAec0LJz_Yy_dw-IfSNeJBo_Wkg49DS8brfen11YSL05ra21nnXuezEUHQoJvA0xK-zyrOAnzRMRZ59UEUQcKPbaz5NqauJ3C025alhkFtQNApY5xEseuIIbiQMQVPtig73Y6vqKuhRtvuegVxv6CUhXwJszTeDYEaGSZtjznRJojlUlP0CdJJzQnLLjYcKYpgsStqxPPGXrHpsXDOOgM2ExWZ1d-mxdFlo1mSZpEr88uc3v_1v1Vnzd_4r6vi7EsKZ-vMJhy0>
<pre class="mermaid">graph LR
A["console.log(a)"] --> B(词法环境块级作用域);
B --> C(函数词法环境);
C --> D(变量环境);
D --> E((END));</pre>
<blockquote>
<p>分析<br>执行可执行代码 <code>console.log(a)</code><br>具体如上流程图延着词法环境栈向下查找，有就返回给 JavaScript 引擎，如果词法环境中没有继续在变量环境中找。结果在变量环境中找到变量 a，打印结果 1；<br>执行可执行代码 <code>console.log(b)</code> b 在词法环境块级作用域中， <code>b=3</code>，打印出 3，块级词法环境出栈。<br>执行函数块中可执行代码 <code>console.log(b)</code>, 打印块级词法环境中 <code>b=2</code>;<br>执行函数块中可执行代码 <code>console.log(c)</code> 打印变量环境中<code>c=4</code>;<br><font color="red">执行函数块中可执行代码 <code>console.log(d)</code> 打印 undefined <strong>因为吧，定义d的作用域已经出栈了</strong></font></p>
</blockquote>
<h4 id="Uncaught-ReferenceError-Cannot-access-‘myname’-before-initialization"><a href="#Uncaught-ReferenceError-Cannot-access-‘myname’-before-initialization" class="headerlink" title="Uncaught ReferenceError: Cannot access ‘myname’ before initialization"></a><font color="red">Uncaught ReferenceError: Cannot access ‘myname’ before initialization</font></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myname= <span class="string">&#x27;helen&#x27;</span>;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(myname);</span><br><span class="line">  <span class="keyword">let</span> myname= <span class="string">&#x27;zhang&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>分析：</code></strong> 块级作用域中，myname 声明提升到了 console.log(myname) 之前，但赋初值 undefined 未初提升。所以 <code>can not access myname before initialization</code>。<strong>所以 let 声明的变量，声明会被提升，但赋初值不被提升。var 声明的变量，赋默认值都会被提升。function 声明、赋值都会被提升。</strong></p>
<blockquote>
<p>变量提升是在变量环境中完成的，而块级作用域是通过词法环境的栈结构实现的，两个结合，JavaScript 就实现了 变量提升与块级作用域了</p>
</blockquote>
<h2 id="5-作用域链"><a href="#5-作用域链" class="headerlink" title="5. 作用域链"></a>5. 作用域链</h2><blockquote>
<p>作用域是程序中定义变量的位置，这个位置决定了变量的可见性或说生命周期<br>  作用域链可以理解为变量的查找路径</p>
</blockquote>
<p><strong><code>outer —— 每个执行上下文的变量环境中用于指向外部的执行上下文的引用。</code></strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;helen&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> name = <span class="string">&#x27;zhang&#x27;</span>;</span><br><span class="line">  <span class="title function_">bar</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img  src=http://www.plantuml.com/plantuml/svg/Aov9JCvMK0B2QYu5XQBKv9B4lFISL8NqdFoan1pd_BoIr8eIXSHY1QMdhIkURcnuigFhoOxkPzFQd_UjVxge6Q9DGI4viIW5giSrhoopA3ylDpKFggz_nilsVeZocBoynDnKM_MCr9pKF7MOPcHxbV9BIrAB56mLyafpSfH01a1CzGS9WrNN8YnKUh6-zzdcgL2dS47a46QbvUSZUm38LNZQllVPr0tFEfU_MDW3zmgA9x2wjoe3Q28Uzu8T2ZGVuKe5E5T1LzSEDJYj59xrj3-TC14IecYEmV0Zq1pytanAB4Bs9f1BgZS9U0ne8hB7O5nAFGOq1zDZN0h8_j6DLYufIimhBaWi0YQdMA1zY3ZbKa2EO4oLA2xZgWK0>
<blockquote>
<p>函数调用时，使用了外部变量，通过 function 关键字声明的函数，会延着执行上下文环境向上查找变量，这个路径就是叫做作用域链<br><strong>JavaScript 执行过程中，其作用域链是由词法作用域决定的。</strong></p>
</blockquote>
<h3 id="6-1-词法作用域"><a href="#6-1-词法作用域" class="headerlink" title="6-1. 词法作用域"></a>6-1. 词法作用域</h3><p><strong>词法作用域</strong> 是指作用域是由代码中函数声明的位置来决定的，所以词法作用域是静态的作用域，通过它就能预测代码在执行过程中如何查找标识。</p>
<blockquote>
<p>词法作用域是代码编译阶段就决定好的，和函数是怎么调用没有关系</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="string">&#x27;a&#x27;</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="string">&#x27;b&#x27;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">afn</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bfn</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> b = <span class="string">&#x27;bb&#x27;</span></span><br><span class="line">  <span class="title function_">cfn</span>()</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">cfn</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(b)</span><br><span class="line">    <span class="title function_">dfn</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dfn</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(b)</span><br><span class="line">  <span class="title function_">afn</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">bfn</span>()</span><br><span class="line"><span class="comment">// bb</span></span><br><span class="line"><span class="comment">// b</span></span><br><span class="line"><span class="comment">// a b</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>分析：<br>  编译：全局变量环境中（a=undefined;b=undefined;function afn(){…};function bfn(){…};function dfn(){…}）<br>  执行：a=’a’;b=’b’;执行bfn()<br>  编译：bfn函数变量环境（b=undefined; function cfn(){…}）<strong>cfn 函数声明的位置在 bfn 函数内部</strong><br>  执行：b=’bb’；函数 cfn 中打印变量 b 为 bb，调用 dfn 函数，<strong>dfn 函数声明的位置在全局上下文中，打印变量 b 为全局上下文环境中的变量 b，结果为 b</strong>，接着在 dfn 中调用 afn，同样 afn 是在全局上下文环境中声明，所以打印全局上下文中的变量 a</p>
</blockquote>
<h3 id="6-2-块级作用域的变量查找"><a href="#6-2-块级作用域的变量查找" class="headerlink" title="6-2. 块级作用域的变量查找"></a>6-2. 块级作用域的变量查找</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> myName = <span class="string">&quot;极客世界&quot;</span></span><br><span class="line">  <span class="keyword">let</span> test1 = <span class="number">100</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> myName = <span class="string">&quot;Chrome浏览器&quot;</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(test)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> myName = <span class="string">&quot;极客邦&quot;</span></span><br><span class="line">  <span class="keyword">let</span> test = <span class="number">2</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">let</span> test = <span class="number">3</span></span><br><span class="line">    <span class="title function_">bar</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> myName = <span class="string">&quot;极客时间&quot;</span></span><br><span class="line"><span class="keyword">let</span> myAge = <span class="number">10</span></span><br><span class="line"><span class="keyword">let</span> test = <span class="number">1</span></span><br><span class="line"><span class="title function_">foo</span>() <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>
<img  src=http://www.plantuml.com/plantuml/svg/bLHDIm916BxxAuRfu4d8FavXK56dg5kNx31keucxCp6EOOHWHTYtbzG2BUgGdlgW3oJepuYpwhzesW_PTLSi5fQTuNdUvtsUzsNJ72af0EMp5m20OOKZab0n44SDyPhNJ-hT-_DsyxJTFDFBXSxbitWu12WD4YgD8NM14ewptA02e22s2Q0eNlSAHHCP9V4CKNYI4X13p76AKnebskuAqd0agD_kYwS7lVBPgxm7eLNCsGlDSCoiMqMbcKqmRPno3jdkyuN-Lh9bjTsv18w4nsUYii4qZuJXdei_rUVdNAvbNwBmhPTUXXgNY2NBnIZtVbPQ-QhRTk_WCTZArpn0gRFQjptCg9y2D0nFGDklGPBLWAXLEb_rzdUrSzKGTtTMCfDmI1HoO2EYa8Y_HY77QXBM44kYc8eNoKwIKQ9Xmlqyk3DgDykTqZdqmcH18oJe6kxa_pEpzPGjHZMiVnIxzMDnqp3RdaTCnTcaWbIRQIjDMEUSj-90skxr_4q-BDTptAolKYMrR2g0GObmNyBwSA53wsES8PBUHamckH6QTJJhcAjy-GpBI_OkjsJwRBoNwVeV178_>
<blockquote>
<p>分析:<br> console.log(test)</p>
</blockquote>
<ol>
<li>if 块级词法环境中查找 —— 无</li>
<li>bar 函数词法作用域中查找 —— 无</li>
<li>bar 函数变量环境中查找 —— 无</li>
<li><strong>bar 在全局作用域中声明的，outer 执行上下文引用指向全局执行上下文，</strong> 首先在全局执行上下文词法环境中查找 —— 找到了，打印 1；若无在，全局执行上下文变量环境中查找</li>
</ol>
<h2 id="7-闭包"><a href="#7-闭包" class="headerlink" title="7. 闭包"></a>7. 闭包</h2><blockquote>
<p><strong>在 JavaScript 中，根据词法作用域的规则，内部函数总是可以访问其外部函数中声明的变量，当通过调用一个外部函数返回一个内部函数后，即使该函数已经执行结束了，但是内部函数引用外部函数的变量依然保存在内存中，我们把这些变量的集合称为<code>闭包</code>。</strong></p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> myName = <span class="string">&#x27;极客时间&#x27;</span></span><br><span class="line">  <span class="keyword">let</span> test1 = <span class="number">1</span></span><br><span class="line">  <span class="keyword">const</span> test2 = <span class="number">2</span></span><br><span class="line">  <span class="keyword">var</span> innerBar = &#123;</span><br><span class="line">    <span class="attr">getName</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(test1)</span><br><span class="line">      <span class="keyword">return</span> myName</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attr">setName</span>: <span class="keyword">function</span>(<span class="params">newName</span>) &#123;</span><br><span class="line">      myName = newName</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> innerBar</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> bar = <span class="title function_">foo</span>()</span><br><span class="line">bar.<span class="title function_">setName</span>(<span class="string">&#x27;极客邦&#x27;</span>)</span><br><span class="line">bar.<span class="title function_">getName</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bar.<span class="title function_">getName</span>())</span><br></pre></td></tr></table></figure>
<p><img src="https://static001.geekbang.org/resource/image/40/a8/40b8840480a5df4f43ad5f4e7907e3a8.png" alt="img"></p>
<blockquote>
<p>分析：<br> foo 函数调用结束后，foo 函数中定义的 getName 函数，依然引用了 foo 函数中的变量 test1 和 myName 造成 foo 函数无法完全退栈。就行成了一个闭包</p>
</blockquote>
<p><strong>函数内部方法包含外部引用，函数无法完全退栈，内部方法引用外部函数的变量依然保存在内存中，就形成了一个闭包</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">closure</span>(foo)</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;极客邦&#x27;</span></span><br><span class="line">  <span class="attr">test1</span>: <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="7-1-闭包怎么回收"><a href="#7-1-闭包怎么回收" class="headerlink" title="7-1.  闭包怎么回收"></a>7-1.  闭包怎么回收</h3><p>闭包使用不正确会造成内存泄漏，如果引用闭包的函数是个全局变量，闭包会一直存在直到页面关闭；如果不在使用就会造成内存泄漏。引用闭包的函数是个局部变量，等函数销毁后，在下次 JavaScript 引擎执行垃圾回收时，判断闭包这块内容不被使用，那么 JavaScript 引擎垃圾回收器会回收这块内存。使用闭包原则 <strong>如果闭包会一直使用，那么它可以作为全局变量存在；如果使用频率不高，占用内存又大，就尽量让它成为一个局部变量</strong></p>
<h2 id="8-JavaScript-中的-this-是什么"><a href="#8-JavaScript-中的-this-是什么" class="headerlink" title="8. JavaScript 中的 this 是什么"></a>8. JavaScript 中的 this 是什么</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;variable name&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> bar = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;the variable name of bar&#x27;</span>,</span><br><span class="line">  <span class="attr">printName</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(name)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> bar.<span class="property">printName</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> _printName = <span class="title function_">foo</span>()</span><br><span class="line"><span class="title function_">_printName</span>()</span><br></pre></td></tr></table></figure>
<p>执行以上代码片断，打印的结果为 <code>variable name</code>。按照其它语言的编程习惯，这里想打印的是 <code>bar.name</code> 即 <code>the variable name of bar</code></p>
<blockquote>
<p>分析：<br>  全局上下文中有两个变量 bar 和 name<br>  bar 有两个属性，name 和 function printName<br>  JavaScript 中的作用域链是由词法作用域决定的，而词法作用域是由代码结构决定的。<br>  所以 function(){console.log(name)} 这个函数是在全局上下文环境中定义的，foo 函数中取的是全局执行上下文中定义的函数<br>  全局上下文环境中取 name 变量，打印的结果为 ‘variable name’</p>
</blockquote>
<p><strong><code>可以通过使用 javaScript this 机制获取对象内部属性</code></strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bar = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;the variable name of bar&#x27;</span>,</span><br><span class="line">  <span class="attr">printName</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">bar.<span class="title function_">printName</span>() <span class="comment">// the variable name of bar</span></span><br></pre></td></tr></table></figure>

<img  src=http://www.plantuml.com/plantuml/svg/AqfDBadCIyz9LNZMkVp5mfudExgUxEX-DgrTePfBGI4viIX5uMd_Z9Vj_S_xrZzTrAoWR6QM1fDuiRxtsUQfM2JoIqjIYr14IZ8oYnMKquoDkMe1>
<p><strong>this 是和执行上下文绑定的</strong>，即每个执行上下文中都有一个 this</p>
<h3 id="8-1-全局执行上下文-this"><a href="#8-1-全局执行上下文-this" class="headerlink" title="8-1.  全局执行上下文 this"></a>8-1.  全局执行上下文 this</h3><p>浏览器环境，全局执行上下文 this 指向 window 对象，window 是 this 和 作用域链的唯一交点，作用域链最低端包含了 window 对象</p>
<h3 id="8-2-函数执行上下文-this"><a href="#8-2-函数执行上下文-this" class="headerlink" title="8-2.  函数执行上下文 this"></a>8-2.  函数执行上下文 this</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>() <span class="comment">// window</span></span><br></pre></td></tr></table></figure>
<p>在全局执行环境中调用函数，其执行上下文中的 this 指向 window 对象。this 指向可以被设置</p>
<h3 id="8-3-设置执行上下文-this-的几种方式"><a href="#8-3-设置执行上下文-this-的几种方式" class="headerlink" title="8-3.  设置执行上下文 this 的几种方式"></a>8-3.  设置执行上下文 this 的几种方式</h3><ol>
<li>通过函数的 call 方法，对象冒充，改变 this 指向<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;zhang&#x27;</span></span><br><span class="line"><span class="keyword">var</span> bar = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;helen&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>()</span><br><span class="line">foo.<span class="title function_">call</span>(bar)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>分析：<br> 代码编译结果 <code>name=undefined;bar=undefined;function foo()&#123;...&#125;</code><br> 代码执行：<code>name=&#39;zhang&#39;;bar=&#123;name: helen&#125;</code> 执行 <code>foo()</code> this 指向 window，取全局环境中的 name ，打印 ‘zhang’<br> 执行 <code>foo.call(bar)</code> 对象冒充，使得 foo 函数中的 this 指向 bar 对象，打印 ‘helen’</p>
</blockquote>
</li>
</ol>
<p>  除了用 call 改变 this 指向问题，还可以使用 <strong>bind</strong>、<strong>apply</strong>，具体就是使用上的区别</p>
<ol start="2">
<li>通过 <strong>对象调用</strong> 改变 this 指向<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;zhang&#x27;</span></span><br><span class="line"><span class="keyword">var</span> myObj = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;helen&#x27;</span>,</span><br><span class="line">  <span class="attr">showName</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">myObj.<span class="title function_">showName</span>() <span class="comment">// &#x27;helen&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>  <strong><code>使用对象调用对象内部方法，this 指向对象本身</code></strong> 也可以理解为 <code>myObj.showName.call(myObj)</code></p>
<blockquote>
<p>this 指向取决于调用者，全局环境调用 this 指向 window，对象调用，this 指向调用对象</p>
</blockquote>
<ol start="3">
<li>通过构造函数中设置<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">ConstructorObj</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;helen&#x27;</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> obj = <span class="keyword">new</span> <span class="title class_">ConstructorObj</span>() <span class="comment">// ConstructorObj &#123;name: &quot;helen&quot;&#125;</span></span><br></pre></td></tr></table></figure>
可以理解为以下代码<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建临时空对象</span></span><br><span class="line"><span class="keyword">var</span> temporaryObject = &#123;&#125;</span><br><span class="line"><span class="comment">// 调用 ConstructorObj.call(temporaryObject) this 指向 ConstructorObj 执行上下文</span></span><br><span class="line"><span class="title class_">ConstructorObj</span>.<span class="title function_">call</span>(temporaryObject)</span><br><span class="line"><span class="comment">// 执行 ConstructorObj 函数，ConstructorObj 函数执行上下文中 this 指向 temporaryObject</span></span><br><span class="line"><span class="comment">// return temporaryObject</span></span><br><span class="line"><span class="keyword">return</span> temporaryObject</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="8-4-this-的设计缺陷及应对方案"><a href="#8-4-this-的设计缺陷及应对方案" class="headerlink" title="8-4.  this 的设计缺陷及应对方案"></a>8-4.  this 的设计缺陷及应对方案</h3><ol>
<li>嵌套函数中的 this 不会从外层函数中继承<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bar = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;hellen&#x27;</span>,</span><br><span class="line">    <span class="attr">fn</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>) <span class="comment">// hellen</span></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>) <span class="comment">// undefined</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">bar</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">bar.<span class="title function_">fn</span>()</span><br></pre></td></tr></table></figure>
<code>function bar()&#123;&#125;</code> this 指向 window 并没有继承 object bar<blockquote>
<p>解决办法（一） <strong>this 转换为作用域</strong></p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bar = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;hellen&#x27;</span>,</span><br><span class="line">    <span class="attr">fn</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>) <span class="comment">// hellen</span></span><br><span class="line">        <span class="keyword">var</span> _this = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(_this.<span class="property">name</span>) <span class="comment">// hellen</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">bar</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">bar.<span class="title function_">fn</span>()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>解决办法（二）：<strong>箭头函数 继承 this</strong><br> 箭头函数不会创建自身执行上下文，箭头函数 this 取决于其外部函数</p>
</blockquote>
</li>
</ol>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bar = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;helen&#x27;</span>,</span><br><span class="line">  <span class="attr">fn</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>); <span class="comment">// helen</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title function_">bar</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>); <span class="comment">// helen</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">bar</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">bar.<span class="title function_">fn</span>()</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>普通函数中的 this 默认指向全局对象 window<br><strong>JavaScript 严格模式下，全局调用一个函数 this 指向 undefined</strong></li>
</ol>
<h2 id="9-关于-this-的-demo-分析"><a href="#9-关于-this-的-demo-分析" class="headerlink" title="9 关于 this 的 demo 分析"></a>9 关于 this 的 demo 分析</h2><p>需求：异步修改用户信息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> userInfo = &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&quot;jack.ma&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>:<span class="number">13</span>,</span><br><span class="line">  <span class="attr">sex</span>:<span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">  <span class="attr">updateInfo</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//模拟xmlhttprequest请求延时</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&quot;pony.ma&quot;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">age</span> = <span class="number">39</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">sex</span> = <span class="string">&#x27;female&#x27;</span></span><br><span class="line">    &#125;,<span class="number">100</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">userInfo.<span class="title function_">updateInfo</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(userInfo)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>分析：<br>  执行结果并不是修改用户信息，而是在全局 window 创建了 name/age/sex 属性并赋上相应的值<br>  具体原因正是函数中 this 的不继承性</p>
</blockquote>
<h3 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h3><ol>
<li> 增加变量 <code>_this</code> 保存父级 this（userInfo 这个对象），这种方式会产生一个闭包<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> userInfo = &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&quot;jack.ma&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>:<span class="number">13</span>,</span><br><span class="line">  <span class="attr">sex</span>:<span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">  <span class="attr">updateInfo</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> _this = <span class="variable language_">this</span></span><br><span class="line">    <span class="comment">//模拟xmlhttprequest请求延时</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">      _this.<span class="property">name</span> = <span class="string">&quot;pony.ma&quot;</span></span><br><span class="line">      _this.<span class="property">age</span> = <span class="number">39</span></span><br><span class="line">      _this.<span class="property">sex</span> = <span class="string">&#x27;female&#x27;</span></span><br><span class="line">    &#125;,<span class="number">100</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">userInfo.<span class="title function_">updateInfo</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(userInfo) <span class="comment">//&#123;name: &quot;jack.ma&quot;, age: 13, sex: &quot;male&quot;, updateInfo: ƒ&#125;</span></span><br></pre></td></tr></table></figure></li>
<li> call/apply/bind 对象冒充<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> userInfo = &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&quot;jack.ma&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>:<span class="number">13</span>,</span><br><span class="line">  <span class="attr">sex</span>:<span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">  <span class="attr">updateInfo</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//模拟xmlhttprequest请求延时</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&quot;pony.ma&quot;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">age</span> = <span class="number">40</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">sex</span> = <span class="string">&#x27;female&#x27;</span></span><br><span class="line">    &#125;.<span class="title function_">call</span>(<span class="variable language_">this</span>),<span class="number">100</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">userInfo.<span class="title function_">updateInfo</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(userInfo) <span class="comment">//&#123;name: &quot;jack.ma&quot;, age: 13, sex: &quot;male&quot;, updateInfo: ƒ&#125;</span></span><br></pre></td></tr></table></figure></li>
<li> 箭头函数，箭头函数不会自己创建 this，可以从上级执行上下文环境中继承 this<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> userInfo = &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&quot;jack.ma&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>:<span class="number">13</span>,</span><br><span class="line">  <span class="attr">sex</span>:<span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">  <span class="attr">updateInfo</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//模拟xmlhttprequest请求延时</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&quot;pony.ma&quot;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">age</span> = <span class="number">41</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">sex</span> = <span class="string">&#x27;female&#x27;</span></span><br><span class="line">    &#125;,<span class="number">100</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">userInfo.<span class="title function_">updateInfo</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(userInfo) <span class="comment">//&#123;name: &quot;jack.ma&quot;, age: 13, sex: &quot;male&quot;, updateInfo: ƒ&#125;</span></span><br></pre></td></tr></table></figure></li>
<li> 传参<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> userInfo = &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&quot;jack.ma&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>:<span class="number">13</span>,</span><br><span class="line">  <span class="attr">sex</span>:<span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">  <span class="attr">updateInfo</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//模拟xmlhttprequest请求延时</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params">_this</span>)&#123;</span><br><span class="line">      _this.<span class="property">name</span> = <span class="string">&quot;pony.ma&quot;</span></span><br><span class="line">      _this.<span class="property">age</span> = <span class="number">42</span></span><br><span class="line">      _this.<span class="property">sex</span> = <span class="string">&#x27;female&#x27;</span></span><br><span class="line">    &#125;(<span class="variable language_">this</span>),<span class="number">100</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">userInfo.<span class="title function_">updateInfo</span>()</span><br></pre></td></tr></table></figure></li>
</ol>

    </div>
</article>


      </div>
      
       <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/HelenZhangLP">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#JavaScript%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.</span> <span class="toc-text">JavaScript代码执行顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JavaScript-%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E4%B8%8E%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-number">2.</span> <span class="toc-text">JavaScript 执行上下文与调用栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ES6-let-%E5%92%8C-const-%E5%A3%B0%E6%98%8E%E5%8F%98%E9%87%8F"><span class="toc-number">3.</span> <span class="toc-text">ES6 let 和 const 声明变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-JavaScript-%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number"></span> <span class="toc-text">1. JavaScript 代码的执行顺序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E8%AE%A4%E8%AF%86%E5%8F%98%E9%87%8F%E6%8F%90%E5%8D%87%EF%BC%88Hoisting%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">1-1. 认识变量提升（Hoisting）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%88%86%E6%9E%90%E4%BB%A3%E7%A0%81%E4%BA%86%E8%A7%A3%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">1-2. 分析代码了解代码执行环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#demo-1-1-%E5%88%86%E6%9E%90%E4%BB%A5%E4%B8%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">2.1.</span> <span class="toc-text">demo-1-1 分析以下代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#demo-1-2-%E5%88%86%E6%9E%90%E4%BB%A5%E4%B8%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.</span> <span class="toc-text">demo-1-2.  分析以下代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-JavaScript-%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E4%B8%8E%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-number"></span> <span class="toc-text">2. JavaScript 执行上下文与调用栈</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-number">1.</span> <span class="toc-text">2-1. 调用栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-demo-%E5%88%86%E6%9E%90%E4%BB%A3%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">2-1-demo. 分析代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#chrome-%E5%BC%80%E5%8F%91%E8%80%85%E5%B7%A5%E5%85%B7%E6%9F%A5%E7%9C%8B%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-number">3.</span> <span class="toc-text">chrome 开发者工具查看调用栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%A0%88%E6%BA%A2%E5%87%BA%EF%BC%88stack-overflow"><span class="toc-number">4.</span> <span class="toc-text">3. 栈溢出（stack overflow)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%A0%88%E6%BA%A2%E5%87%BA"><span class="toc-number">4.1.</span> <span class="toc-text">解决栈溢出</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-JavaScript-let-const-%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E"><span class="toc-number"></span> <span class="toc-text">4. JavaScript let const 变量声明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%8F%98%E9%87%8F%E6%8F%90%E5%8D%87%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">4-1 变量提升带来的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-%E5%AE%B9%E6%98%93%E5%9C%A8%E6%97%A0%E6%84%8F%E8%AF%86%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96"><span class="toc-number">1.1.</span> <span class="toc-text">4-1-1. 容易在无意识的情况下变量覆盖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-%E5%8F%98%E9%87%8F%E6%9C%AA%E8%83%BD%E5%8F%8A%E6%97%B6%E9%94%80%E6%AF%81"><span class="toc-number">1.2.</span> <span class="toc-text">4-1-2. 变量未能及时销毁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E9%80%9A%E8%BF%87-let-const-JavaScript%E5%9D%97%E7%BA%A7%E4%BD%9C%E7%94%A8%E5%9F%9F-%E8%A7%A3%E5%86%B3%E5%8F%98%E9%87%8F%E6%8F%90%E5%8D%87%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">4-2. 通过 let&#x2F;const + JavaScript块级作用域 解决变量提升的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-%E4%BD%9C%E7%94%A8%E5%9F%9F%EF%BC%88scope%EF%BC%89"><span class="toc-number">2.1.</span> <span class="toc-text">4-2-1.  作用域（scope）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-%E8%A7%A3%E5%86%B3%E5%8F%98%E9%87%8F%E6%8F%90%E5%8D%87%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.</span> <span class="toc-text">4-2-2. 解决变量提升的问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-ES6-%E6%80%8E%E4%B9%88%E5%85%BC%E5%AE%B9%E5%8F%98%E9%87%8F%E6%8F%90%E5%8D%87%E5%92%8C%E5%9D%97%E7%BA%A7%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9A%84"><span class="toc-number"></span> <span class="toc-text">4-3. ES6 怎么兼容变量提升和块级作用域的</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Uncaught-ReferenceError-Cannot-access-%E2%80%98myname%E2%80%99-before-initialization"><span class="toc-number">0.1.</span> <span class="toc-text">Uncaught ReferenceError: Cannot access ‘myname’ before initialization</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E4%BD%9C%E7%94%A8%E5%9F%9F%E9%93%BE"><span class="toc-number"></span> <span class="toc-text">5. 作用域链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E8%AF%8D%E6%B3%95%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-number">1.</span> <span class="toc-text">6-1. 词法作用域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%9D%97%E7%BA%A7%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9A%84%E5%8F%98%E9%87%8F%E6%9F%A5%E6%89%BE"><span class="toc-number">2.</span> <span class="toc-text">6-2. 块级作用域的变量查找</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E9%97%AD%E5%8C%85"><span class="toc-number"></span> <span class="toc-text">7. 闭包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E9%97%AD%E5%8C%85%E6%80%8E%E4%B9%88%E5%9B%9E%E6%94%B6"><span class="toc-number">1.</span> <span class="toc-text">7-1.  闭包怎么回收</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-JavaScript-%E4%B8%AD%E7%9A%84-this-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number"></span> <span class="toc-text">8. JavaScript 中的 this 是什么</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%85%A8%E5%B1%80%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87-this"><span class="toc-number">1.</span> <span class="toc-text">8-1.  全局执行上下文 this</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87-this"><span class="toc-number">2.</span> <span class="toc-text">8-2.  函数执行上下文 this</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E8%AE%BE%E7%BD%AE%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87-this-%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">8-3.  设置执行上下文 this 的几种方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-this-%E7%9A%84%E8%AE%BE%E8%AE%A1%E7%BC%BA%E9%99%B7%E5%8F%8A%E5%BA%94%E5%AF%B9%E6%96%B9%E6%A1%88"><span class="toc-number">4.</span> <span class="toc-text">8-4.  this 的设计缺陷及应对方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E5%85%B3%E4%BA%8E-this-%E7%9A%84-demo-%E5%88%86%E6%9E%90"><span class="toc-number"></span> <span class="toc-text">9 关于 this 的 demo 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">解决办法：</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&text=浏览器工作原理——浏览器中的JavaScript执行机制"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=浏览器工作原理——浏览器中的JavaScript执行机制"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&is_video=false&description=浏览器工作原理——浏览器中的JavaScript执行机制"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=浏览器工作原理——浏览器中的JavaScript执行机制&body=Check out this article: https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=浏览器工作原理——浏览器中的JavaScript执行机制"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=浏览器工作原理——浏览器中的JavaScript执行机制"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=浏览器工作原理——浏览器中的JavaScript执行机制"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&title=浏览器工作原理——浏览器中的JavaScript执行机制"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://helenzhanglp.github.io/2020/11/18/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E2%80%94%E2%80%94Javascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/&name=浏览器工作原理——浏览器中的JavaScript执行机制&description=&lt;blockquote&gt;
&lt;h3 id=&#34;JavaScript代码执行顺序&#34;&gt;&lt;a href=&#34;#JavaScript代码执行顺序&#34; class=&#34;headerlink&#34; title=&#34;JavaScript代码执行顺序&#34;&gt;&lt;/a&gt;&lt;a href=&#34;#codeExecutionOrder&#34;&gt;JavaScript代码执行顺序&lt;/a&gt;&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;先编译（&lt;u&gt;编译出&lt;strong&gt;执行上下文（Execution context）&lt;/strong&gt;与可执行代码&lt;/u&gt;）、后执行&lt;br&gt;     代码编译阶段 var 声明的变量会产生 &lt;strong&gt;变量提升&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;JavaScript-执行上下文与调用栈&#34;&gt;&lt;a href=&#34;#JavaScript-执行上下文与调用栈&#34; class=&#34;headerlink&#34; title=&#34;JavaScript 执行上下文与调用栈&#34;&gt;&lt;/a&gt;&lt;a href=&#34;#callStack&#34;&gt;JavaScript 执行上下文与调用栈&lt;/a&gt;&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;u&gt;调用栈是用来管理函数调用关系的一种&lt;strong&gt;数据结构&lt;/strong&gt;&lt;code&gt;Maximum call stack exceeded&lt;/code&gt;&lt;/u&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;ES6-let-和-const-声明变量&#34;&gt;&lt;a href=&#34;#ES6-let-和-const-声明变量&#34; class=&#34;headerlink&#34; title=&#34;ES6 let 和 const 声明变量&#34;&gt;&lt;/a&gt;&lt;a href=&#34;#letAndConst&#34;&gt;ES6 let 和 const 声明变量&lt;/a&gt;&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;var 会引起变量提升，变量提升产生变量污染、消耗一部分无用的内存。&lt;br&gt;     var 声明变量引起变量提升——容易在无意识的情况下变量覆盖&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;通过 let 和 const 解决变量提升，ECMAScript6 中，提出的 let 和 const 有块级作用域的概念。很好的解决了变量提升的问题&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
&lt;li&gt;&lt;input disabled type=&#34;checkbox&#34;&gt; 作用域链与闭包&lt;ul&gt;
&lt;li&gt;作用域变量的有效性和生命周期&lt;/li&gt;
&lt;li&gt;闭包嵌套函数，内部引用外出变量，外部函数执行结束后，不能完全退栈。内部函数存在外部函数的变量引用&lt;/li&gt;
&lt;li&gt;this 与变量不同，内部函数不能继承外部函数的 this。解决办法有三种：&lt;ol&gt;
&lt;li&gt;this 转换为作用域，将 this 赋值给变量，内部函数访问 this 赋值的变量；&lt;/li&gt;
&lt;li&gt;箭头函数继承上一级的 this&lt;/li&gt;
&lt;li&gt;采用 call/apply/bind 其一，进行对象冒充&lt;/li&gt;
&lt;li&gt;传参&lt;span id=&#34;more&#34;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;1-JavaScript-代码的执行顺序&#34;&gt;&lt;a href=&#34;#1-JavaScript-代码的执行顺序&#34; class=&#34;headerlink&#34; title=&#34;1. JavaScript 代码的执行顺序&#34;&gt;&lt;/a&gt;&lt;a name=&#34;codeExecutionOrder&#34;&gt;1. JavaScript 代码的执行顺序&lt;/a&gt;&lt;/h2&gt;&lt;p&gt;JavaScript 代码是&lt;strong&gt;按顺序执行&lt;/strong&gt;的&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;分析以下代码&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&#34;highlight javascript&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable language_&#34;&gt;console&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;log&lt;/span&gt;(name)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable language_&#34;&gt;console&lt;/span&gt;.&lt;span class=&#34;title function_&#34;&gt;log&lt;/span&gt;(undefinedvariable)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;var&lt;/span&gt; name; &lt;span class=&#34;comment&#34;&gt;// 声明&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;name = &lt;span class=&#34;number&#34;&gt;123&lt;/span&gt;; &lt;span class=&#34;comment&#34;&gt;// 赋值部分&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;/*&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;  undefined&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;  Uncaught ReferenceError: undefinedvariable is not defined&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;    at &amp;lt;anonymous&amp;gt;:2:13&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;*/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;变量 name 后定义，提前使用打印或undefined，未声明变量 undefinedvariable 报错 is not defined，怎么理解&lt;/p&gt;
&lt;h3 id=&#34;1-1-认识变量提升（Hoisting）&#34;&gt;&lt;a href=&#34;#1-1-认识变量提升（Hoisting）&#34; class=&#34;headerlink&#34; title=&#34;1-1. 认识变量提升（Hoisting）&#34;&gt;&lt;/a&gt;1-1. 认识变量提升（Hoisting）&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;del&gt;JavaScript 代码执行过程中，JavaScript 引擎把变量声明部分和函数声明部分提升到代码开头的行为&lt;/del&gt;&lt;code&gt;JavaScript 代码在编译过程中，被 JavaScript 引擎放入内存的行为&lt;/code&gt;，叫做 &lt;strong&gt;变量提升&lt;/strong&gt;。&lt;/p&gt;
&lt;/blockquote&gt;"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

      
      <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2024
      Helen Zhang
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        
          <li><a href="/">
              Home
            </a></li>
          
          <li><a href="/about/">
              About
            </a></li>
          
          <li><a href="/archives/">
              Writing
            </a></li>
          
          <li><a href="/tags/">
              Tags
            </a></li>
          
          <li><a target="_blank" rel="noopener" href="https://github.com/HelenZhangLP">
              Projects
            </a></li>
          
      </ul>
    </nav>
  </div>
</footer>


  <!-- <script src='https://unpkg.com/mermaid@10.4.0/dist/mermaid.min.js'></script> -->
  <script src="https://cdn.bootcdn.net/ajax/libs/mermaid/10.4.0/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({ theme: 'default' });
    }
  </script>
  
      
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->

<!-- Disqus Comments -->


    </div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
